<html>
<head>
  <title>多进程</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600753 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1984"/>
<h1>多进程</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2019/9/3 21:19</i></td></tr>
</table>
</div>
<br/>

<div><span>
  <div style="--en-clipped-content:article">
<div><br/></div><div style="font-size: 16px; display:block; min-width: 100%; position: relative;"> <div style="font:14px/20px &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;text-size-adjust:100%;background:rgb(255, 255, 255);color:rgb(68, 68, 68);"><div style="font-family:&quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:14px;line-height:20px;color:rgb(102, 102, 102);background-color:rgb(255, 255, 255);"><div><div style="box-sizing:border-box;"><div style="list-style:none;"><div style="box-sizing:border-box;"><div><div><div>
								    <h4 style="margin:0px 0px 15px;font-family:&quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-weight:normal;color:rgb(68, 68, 68);text-transform:none;font-size:16px;line-height:22px;">多进程</h4>
    <div>
    	<span>阅读: 5577165</span>
    	</div>

    <hr style="box-sizing:content-box;height:0px;margin:15px 0px;border-width:1px 0px 0px;border-right-style:initial;border-bottom-style:initial;border-left-style:initial;border-right-color:initial;border-bottom-color:initial;border-left-color:initial;border-image:initial;border-top-style:solid;border-top-color:rgb(221, 221, 221);"/>

    <div><p style="margin:0px 0px 15px;">要让Python程序实现多进程（multiprocessing），我们先了解操作系统的相关知识。</p>
<p style="margin:0px 0px 15px;margin-top:15px;">Unix/Linux操作系统提供了一个<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">fork()</code>系统调用，它非常特殊。普通的函数调用，调用一次，返回一次，但是<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">fork()</code>调用一次，返回两次，因为操作系统自动把当前进程（称为父进程）复制了一份（称为子进程），然后，分别在父进程和子进程内返回。</p>
<p style="margin:0px 0px 15px;margin-top:15px;">子进程永远返回<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">0</code>，而父进程返回子进程的ID。这样做的理由是，一个父进程可以fork出很多子进程，所以，父进程要记下每个子进程的ID，而子进程只需要调用<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">getppid()</code>就可以拿到父进程的ID。</p>
<p style="margin:0px 0px 15px;margin-top:15px;">Python的<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">os</code>模块封装了常见的系统调用，其中就包括<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">fork</code>，可以在Python程序中轻松创建子进程：</p>
<pre style="margin:0px 0px 15px;margin-top:15px;padding:10px;background:rgb(250, 250, 250);font:12px/18px Consolas, monospace, serif;color:rgb(68, 68, 68);tab-size:4;overflow:auto;border:1px solid rgb(221, 221, 221);border-radius:3px;"><code style="white-space:pre-wrap;"><span style="color:rgb(51, 51, 51);font-weight:bold;">import</span> os

print(<span style="color:rgb(221, 17, 68);">'Process (%s) start...'</span> % os.getpid())
<span style="color:rgb(153, 153, 136);font-style:italic;"># Only works on Unix/Linux/Mac:</span>
pid = os.fork()
<span style="color:rgb(51, 51, 51);font-weight:bold;">if</span> pid == <span style="color:rgb(0, 153, 153);">0</span>:
    print(<span style="color:rgb(221, 17, 68);">'I am child process (%s) and my parent is %s.'</span> % (os.getpid(), os.getppid()))
<span style="color:rgb(51, 51, 51);font-weight:bold;">else</span>:
    print(<span style="color:rgb(221, 17, 68);">'I (%s) just created a child process (%s).'</span> % (os.getpid(), pid))
</code></pre>
<p style="margin:0px 0px 15px;margin-top:15px;">运行结果如下：</p>
<pre style="margin:0px 0px 15px;margin-top:15px;padding:10px;background:rgb(250, 250, 250);font:12px/18px Consolas, monospace, serif;color:rgb(68, 68, 68);tab-size:4;overflow:auto;border:1px solid rgb(221, 221, 221);border-radius:3px;"><code style="white-space:pre-wrap;">Process (876) <span><span style="color:rgb(51, 51, 51);font-weight:bold;">start</span>...
I (<span style="color:rgb(0, 153, 153);">876</span>) just created a child process (<span style="color:rgb(0, 153, 153);">877</span>).
I am child process (<span style="color:rgb(0, 153, 153);">877</span>) <span style="color:rgb(51, 51, 51);font-weight:bold;">and</span> my parent <span style="color:rgb(51, 51, 51);font-weight:bold;">is</span> <span style="color:rgb(0, 153, 153);">876.</span>
</span></code></pre>
<p style="margin:0px 0px 15px;margin-top:15px;">由于Windows没有<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">fork</code>调用，上面的代码在Windows上无法运行。由于Mac系统是基于BSD（Unix的一种）内核，所以，在Mac下运行是没有问题的，推荐大家用Mac学Python！</p>
<p style="margin:0px 0px 15px;margin-top:15px;">有了<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">fork</code>调用，一个进程在接到新任务时就可以复制出一个子进程来处理新任务，常见的Apache服务器就是由父进程监听端口，每当有新的http请求时，就fork出子进程来处理新的http请求。</p>
<h3 style="margin:0px 0px 15px;font-family:&quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-weight:normal;color:rgb(68, 68, 68);text-transform:none;margin-top:25px;font-size:18px;line-height:24px;">multiprocessing</h3>
<p style="margin:0px 0px 15px;margin-top:15px;">如果你打算编写多进程的服务程序，Unix/Linux无疑是正确的选择。由于Windows没有<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">fork</code>调用，难道在Windows上无法用Python编写多进程的程序？</p>
<p style="margin:0px 0px 15px;margin-top:15px;">由于Python是跨平台的，自然也应该提供一个跨平台的多进程支持。<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">multiprocessing</code>模块就是跨平台版本的多进程模块。</p>
<p style="margin:0px 0px 15px;margin-top:15px;"><code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">multiprocessing</code>模块提供了一个<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">Process</code>类来代表一个进程对象，下面的例子演示了启动一个子进程并等待其结束：</p>
<pre style="margin:0px 0px 15px;margin-top:15px;padding:10px;background:rgb(250, 250, 250);font:12px/18px Consolas, monospace, serif;color:rgb(68, 68, 68);tab-size:4;overflow:auto;border:1px solid rgb(221, 221, 221);border-radius:3px;"><code style="white-space:pre-wrap;"><span style="color:rgb(51, 51, 51);font-weight:bold;">from</span> multiprocessing <span style="color:rgb(51, 51, 51);font-weight:bold;">import</span> Process
<span style="color:rgb(51, 51, 51);font-weight:bold;">import</span> os

<span style="color:rgb(153, 153, 136);font-style:italic;"># 子进程要执行的代码</span>
<span><span style="color:rgb(51, 51, 51);font-weight:bold;">def</span> <span style="color:rgb(153, 0, 0);font-weight:bold;">run_proc</span><span>(name)</span>:</span>
    print(<span style="color:rgb(221, 17, 68);">'Run child process %s (%s)...'</span> % (name, os.getpid()))

<span style="color:rgb(51, 51, 51);font-weight:bold;">if</span> __name__==<span style="color:rgb(221, 17, 68);">'__main__'</span>:
    print(<span style="color:rgb(221, 17, 68);">'Parent process %s.'</span> % os.getpid())
    p = Process(target=run_proc, args=(<span style="color:rgb(221, 17, 68);">'test'</span>,))
    print(<span style="color:rgb(221, 17, 68);">'Child process will start.'</span>)
    p.start()
    p.join()
    print(<span style="color:rgb(221, 17, 68);">'Child process end.'</span>)
</code></pre>
<p style="margin:0px 0px 15px;margin-top:15px;">执行结果如下：</p>
<pre style="margin:0px 0px 15px;margin-top:15px;padding:10px;background:rgb(250, 250, 250);font:12px/18px Consolas, monospace, serif;color:rgb(68, 68, 68);tab-size:4;overflow:auto;border:1px solid rgb(221, 221, 221);border-radius:3px;"><code style="white-space:pre-wrap;">Parent process 928.
Process will <span><span style="color:rgb(51, 51, 51);font-weight:bold;">start</span>.
Run child process test (<span style="color:rgb(0, 153, 153);">929</span>)...
Process <span style="color:rgb(51, 51, 51);font-weight:bold;">end</span>.
</span></code></pre>
<p style="margin:0px 0px 15px;margin-top:15px;">创建子进程时，只需要传入一个执行函数和函数的参数，创建一个<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">Process</code>实例，用<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">start()</code>方法启动，这样创建进程比<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">fork()</code>还要简单。</p>
<p style="margin:0px 0px 15px;margin-top:15px;"><code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">join()</code>方法可以等待子进程结束后再继续往下运行，通常用于进程间的同步。</p>
<h3 style="margin:0px 0px 15px;font-family:&quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-weight:normal;color:rgb(68, 68, 68);text-transform:none;margin-top:25px;font-size:18px;line-height:24px;">Pool</h3>
<p style="margin:0px 0px 15px;margin-top:15px;">如果要启动大量的子进程，可以用进程池的方式批量创建子进程：</p>
<pre style="margin:0px 0px 15px;margin-top:15px;padding:10px;background:rgb(250, 250, 250);font:12px/18px Consolas, monospace, serif;color:rgb(68, 68, 68);tab-size:4;overflow:auto;border:1px solid rgb(221, 221, 221);border-radius:3px;"><code style="white-space:pre-wrap;"><span style="color:rgb(51, 51, 51);font-weight:bold;">from</span> multiprocessing <span style="color:rgb(51, 51, 51);font-weight:bold;">import</span> Pool
<span style="color:rgb(51, 51, 51);font-weight:bold;">import</span> os, time, random

<span><span style="color:rgb(51, 51, 51);font-weight:bold;">def</span> <span style="color:rgb(153, 0, 0);font-weight:bold;">long_time_task</span><span>(name)</span>:</span>
    print(<span style="color:rgb(221, 17, 68);">'Run task %s (%s)...'</span> % (name, os.getpid()))
    start = time.time()
    time.sleep(random.random() * <span style="color:rgb(0, 153, 153);">3</span>)
    end = time.time()
    print(<span style="color:rgb(221, 17, 68);">'Task %s runs %0.2f seconds.'</span> % (name, (end - start)))

<span style="color:rgb(51, 51, 51);font-weight:bold;">if</span> __name__==<span style="color:rgb(221, 17, 68);">'__main__'</span>:
    print(<span style="color:rgb(221, 17, 68);">'Parent process %s.'</span> % os.getpid())
    p = Pool(<span style="color:rgb(0, 153, 153);">4</span>)
    <span style="color:rgb(51, 51, 51);font-weight:bold;">for</span> i <span style="color:rgb(51, 51, 51);font-weight:bold;">in</span> range(<span style="color:rgb(0, 153, 153);">5</span>):
        p.apply_async(long_time_task, args=(i,))
    print(<span style="color:rgb(221, 17, 68);">'Waiting for all subprocesses done...'</span>)
    p.close()
    p.join()
    print(<span style="color:rgb(221, 17, 68);">'All subprocesses done.'</span>)
</code></pre>
<p style="margin:0px 0px 15px;margin-top:15px;">执行结果如下：</p>
<pre style="margin:0px 0px 15px;margin-top:15px;padding:10px;background:rgb(250, 250, 250);font:12px/18px Consolas, monospace, serif;color:rgb(68, 68, 68);tab-size:4;overflow:auto;border:1px solid rgb(221, 221, 221);border-radius:3px;"><code style="white-space:pre-wrap;"><span style="color:rgb(51, 51, 51);font-weight:bold;">Parent</span> process <span style="color:rgb(0, 153, 153);">669.</span>
Waiting <span style="color:rgb(51, 51, 51);font-weight:bold;">for</span> all subprocesses done...
Run task <span style="color:rgb(0, 153, 153);">0</span> (<span style="color:rgb(0, 153, 153);">671</span>)...
Run task <span style="color:rgb(0, 153, 153);">1</span> (<span style="color:rgb(0, 153, 153);">672</span>)...
Run task <span style="color:rgb(0, 153, 153);">2</span> (<span style="color:rgb(0, 153, 153);">673</span>)...
Run task <span style="color:rgb(0, 153, 153);">3</span> (<span style="color:rgb(0, 153, 153);">674</span>)...
Task <span style="color:rgb(0, 153, 153);">2</span> runs <span style="color:rgb(0, 153, 153);">0.14</span> seconds.
Run task <span style="color:rgb(0, 153, 153);">4</span> (<span style="color:rgb(0, 153, 153);">673</span>)...
Task <span style="color:rgb(0, 153, 153);">1</span> runs <span style="color:rgb(0, 153, 153);">0.27</span> seconds.
Task <span style="color:rgb(0, 153, 153);">3</span> runs <span style="color:rgb(0, 153, 153);">0.86</span> seconds.
Task <span style="color:rgb(0, 153, 153);">0</span> runs <span style="color:rgb(0, 153, 153);">1.41</span> seconds.
Task <span style="color:rgb(0, 153, 153);">4</span> runs <span style="color:rgb(0, 153, 153);">1.91</span> seconds.
All subprocesses done.
</code></pre>
<p style="margin:0px 0px 15px;margin-top:15px;">代码解读：</p>
<p style="margin:0px 0px 15px;margin-top:15px;">对<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">Pool</code>对象调用<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">join()</code>方法会等待所有子进程执行完毕，调用<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">join()</code>之前必须先调用<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">close()</code>，调用<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">close()</code>之后就不能继续添加新的<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">Process</code>了。</p>
<p style="margin:0px 0px 15px;margin-top:15px;">请注意输出的结果，task <code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">0</code>，<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">1</code>，<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">2</code>，<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">3</code>是立刻执行的，而task <code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">4</code>要等待前面某个task完成后才执行，这是因为<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">Pool</code>的默认大小在我的电脑上是4，因此，最多同时执行4个进程。这是<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">Pool</code>有意设计的限制，并不是操作系统的限制。如果改成：</p>
<pre style="margin:0px 0px 15px;margin-top:15px;padding:10px;background:rgb(250, 250, 250);font:12px/18px Consolas, monospace, serif;color:rgb(68, 68, 68);tab-size:4;overflow:auto;border:1px solid rgb(221, 221, 221);border-radius:3px;"><code style="white-space:pre-wrap;"><span>p = <span>Pool(<span style="color:rgb(0, 153, 153);">5</span>)</span></span>
</code></pre>
<p style="margin:0px 0px 15px;margin-top:15px;">就可以同时跑5个进程。</p>
<p style="margin:0px 0px 15px;margin-top:15px;">由于<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">Pool</code>的默认大小是CPU的核数，如果你不幸拥有8核CPU，你要提交至少9个子进程才能看到上面的等待效果。</p>
<h3 style="margin:0px 0px 15px;font-family:&quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-weight:normal;color:rgb(68, 68, 68);text-transform:none;margin-top:25px;font-size:18px;line-height:24px;">子进程</h3>
<p style="margin:0px 0px 15px;margin-top:15px;">很多时候，子进程并不是自身，而是一个外部进程。我们创建了子进程后，还需要控制子进程的输入和输出。</p>
<p style="margin:0px 0px 15px;margin-top:15px;"><code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">subprocess</code>模块可以让我们非常方便地启动一个子进程，然后控制其输入和输出。</p>
<p style="margin:0px 0px 15px;margin-top:15px;">下面的例子演示了如何在Python代码中运行命令<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">nslookup www.python.org</code>，这和命令行直接运行的效果是一样的：</p>
<pre style="margin:0px 0px 15px;margin-top:15px;padding:10px;background:rgb(250, 250, 250);font:12px/18px Consolas, monospace, serif;color:rgb(68, 68, 68);tab-size:4;overflow:auto;border:1px solid rgb(221, 221, 221);border-radius:3px;"><code style="white-space:pre-wrap;"><span style="color:rgb(51, 51, 51);font-weight:bold;">import</span> subprocess

print(<span style="color:rgb(221, 17, 68);">'$ nslookup www.python.org'</span>)
r = subprocess.call([<span style="color:rgb(221, 17, 68);">'nslookup'</span>, <span style="color:rgb(221, 17, 68);">'www.python.org'</span>])
print(<span style="color:rgb(221, 17, 68);">'Exit code:'</span>, r)
</code></pre>
<p style="margin:0px 0px 15px;margin-top:15px;">运行结果：</p>
<pre style="margin:0px 0px 15px;margin-top:15px;padding:10px;background:rgb(250, 250, 250);font:12px/18px Consolas, monospace, serif;color:rgb(68, 68, 68);tab-size:4;overflow:auto;border:1px solid rgb(221, 221, 221);border-radius:3px;"><code style="white-space:pre-wrap;"><span style="color:rgb(0, 128, 128);">$ </span>nslookup www.python.org
<span style="color:rgb(0, 153, 153);">Server</span><span style="color:rgb(153, 0, 115);">:</span>		<span style="color:rgb(0, 153, 153);">192.168</span>.<span style="color:rgb(0, 153, 153);">19.4</span>
<span style="color:rgb(0, 153, 153);">Address</span><span style="color:rgb(153, 0, 115);">:</span>	<span style="color:rgb(0, 153, 153);">192.168</span>.<span style="color:rgb(0, 153, 153);">19.4</span><span style="color:rgb(153, 153, 136);font-style:italic;">#53</span>

<span style="color:rgb(0, 153, 153);">Non</span>-authoritative <span style="color:rgb(153, 0, 115);">answer:</span>
www.python.org	canonical name = python.map.fastly.net.
<span style="color:rgb(0, 153, 153);">Name</span><span style="color:rgb(153, 0, 115);">:</span>	python.map.fastly.net
<span style="color:rgb(0, 153, 153);">Address</span><span style="color:rgb(153, 0, 115);">:</span> <span style="color:rgb(0, 153, 153);">199.27</span>.<span style="color:rgb(0, 153, 153);">79.223</span>

<span style="color:rgb(0, 153, 153);">Exit</span> <span style="color:rgb(153, 0, 115);">code:</span> <span style="color:rgb(0, 153, 153);">0</span>
</code></pre>
<p style="margin:0px 0px 15px;margin-top:15px;">如果子进程还需要输入，则可以通过<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">communicate()</code>方法输入：</p>
<pre style="margin:0px 0px 15px;margin-top:15px;padding:10px;background:rgb(250, 250, 250);font:12px/18px Consolas, monospace, serif;color:rgb(68, 68, 68);tab-size:4;overflow:auto;border:1px solid rgb(221, 221, 221);border-radius:3px;"><code style="white-space:pre-wrap;"><span style="color:rgb(51, 51, 51);font-weight:bold;">import</span> subprocess

print(<span style="color:rgb(221, 17, 68);">'$ nslookup'</span>)
p = subprocess.Popen([<span style="color:rgb(221, 17, 68);">'nslookup'</span>], stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
output, err = p.communicate(<span style="color:rgb(221, 17, 68);">b'set q=mx\npython.org\nexit\n'</span>)
print(output.decode(<span style="color:rgb(221, 17, 68);">'utf-8'</span>))
print(<span style="color:rgb(221, 17, 68);">'Exit code:'</span>, p.returncode)
</code></pre>
<p style="margin:0px 0px 15px;margin-top:15px;">上面的代码相当于在命令行执行命令<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">nslookup</code>，然后手动输入：</p>
<pre style="margin:0px 0px 15px;margin-top:15px;padding:10px;background:rgb(250, 250, 250);font:12px/18px Consolas, monospace, serif;color:rgb(68, 68, 68);tab-size:4;overflow:auto;border:1px solid rgb(221, 221, 221);border-radius:3px;"><code style="white-space:pre-wrap;"><span><span style="color:rgb(51, 51, 51);font-weight:bold;">set</span> q=mx
python.org
exit
</span></code></pre>
<p style="margin:0px 0px 15px;margin-top:15px;">运行结果如下：</p>
<pre style="margin:0px 0px 15px;margin-top:15px;padding:10px;background:rgb(250, 250, 250);font:12px/18px Consolas, monospace, serif;color:rgb(68, 68, 68);tab-size:4;overflow:auto;border:1px solid rgb(221, 221, 221);border-radius:3px;"><code style="white-space:pre-wrap;"><span style="color:rgb(0, 128, 128);">$ </span>nslookup
<span style="color:rgb(0, 153, 153);">Server</span><span style="color:rgb(153, 0, 115);">:</span>		<span style="color:rgb(0, 153, 153);">192.168</span>.<span style="color:rgb(0, 153, 153);">19.4</span>
<span style="color:rgb(0, 153, 153);">Address</span><span style="color:rgb(153, 0, 115);">:</span>	<span style="color:rgb(0, 153, 153);">192.168</span>.<span style="color:rgb(0, 153, 153);">19.4</span><span style="color:rgb(153, 153, 136);font-style:italic;">#53</span>

<span style="color:rgb(0, 153, 153);">Non</span>-authoritative <span style="color:rgb(153, 0, 115);">answer:</span>
python.org	mail exchanger = <span style="color:rgb(0, 153, 153);">50</span> mail.python.org.

<span style="color:rgb(0, 153, 153);">Authoritative</span> answers can be found <span style="color:rgb(153, 0, 115);">from:</span>
mail.python.org	internet address = <span style="color:rgb(0, 153, 153);">82.94</span>.<span style="color:rgb(0, 153, 153);">164.166</span>
mail.python.org	has <span style="color:rgb(0, 153, 153);">AAAA</span> address <span style="color:rgb(0, 153, 153);">2001</span><span style="color:rgb(153, 0, 115);">:</span><span style="color:rgb(0, 153, 153);">888</span><span style="color:rgb(153, 0, 115);">:</span><span style="color:rgb(0, 153, 153);">2000</span><span style="color:rgb(153, 0, 115);">:d</span><span style="color:rgb(153, 0, 115);">:</span><span style="color:rgb(153, 0, 115);">:a6</span>


<span style="color:rgb(0, 153, 153);">Exit</span> <span style="color:rgb(153, 0, 115);">code:</span> <span style="color:rgb(0, 153, 153);">0</span>
</code></pre>
<h3 style="margin:0px 0px 15px;font-family:&quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-weight:normal;color:rgb(68, 68, 68);text-transform:none;margin-top:25px;font-size:18px;line-height:24px;">进程间通信</h3>
<p style="margin:0px 0px 15px;margin-top:15px;"><code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">Process</code>之间肯定是需要通信的，操作系统提供了很多机制来实现进程间的通信。Python的<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">multiprocessing</code>模块包装了底层的机制，提供了<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">Queue</code>、<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">Pipes</code>等多种方式来交换数据。</p>
<p style="margin:0px 0px 15px;margin-top:15px;">我们以<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">Queue</code>为例，在父进程中创建两个子进程，一个往<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">Queue</code>里写数据，一个从<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">Queue</code>里读数据：</p>
<pre style="margin:0px 0px 15px;margin-top:15px;padding:10px;background:rgb(250, 250, 250);font:12px/18px Consolas, monospace, serif;color:rgb(68, 68, 68);tab-size:4;overflow:auto;border:1px solid rgb(221, 221, 221);border-radius:3px;"><code style="white-space:pre-wrap;"><span style="color:rgb(51, 51, 51);font-weight:bold;">from</span> multiprocessing <span style="color:rgb(51, 51, 51);font-weight:bold;">import</span> Process, Queue
<span style="color:rgb(51, 51, 51);font-weight:bold;">import</span> os, time, random

<span style="color:rgb(153, 153, 136);font-style:italic;"># 写数据进程执行的代码:</span>
<span><span style="color:rgb(51, 51, 51);font-weight:bold;">def</span> <span style="color:rgb(153, 0, 0);font-weight:bold;">write</span><span>(q)</span>:</span>
    print(<span style="color:rgb(221, 17, 68);">'Process to write: %s'</span> % os.getpid())
    <span style="color:rgb(51, 51, 51);font-weight:bold;">for</span> value <span style="color:rgb(51, 51, 51);font-weight:bold;">in</span> [<span style="color:rgb(221, 17, 68);">'A'</span>, <span style="color:rgb(221, 17, 68);">'B'</span>, <span style="color:rgb(221, 17, 68);">'C'</span>]:
        print(<span style="color:rgb(221, 17, 68);">'Put %s to queue...'</span> % value)
        q.put(value)
        time.sleep(random.random())

<span style="color:rgb(153, 153, 136);font-style:italic;"># 读数据进程执行的代码:</span>
<span><span style="color:rgb(51, 51, 51);font-weight:bold;">def</span> <span style="color:rgb(153, 0, 0);font-weight:bold;">read</span><span>(q)</span>:</span>
    print(<span style="color:rgb(221, 17, 68);">'Process to read: %s'</span> % os.getpid())
    <span style="color:rgb(51, 51, 51);font-weight:bold;">while</span> <span style="color:rgb(0, 134, 179);">True</span>:
        value = q.get(<span style="color:rgb(0, 134, 179);">True</span>)
        print(<span style="color:rgb(221, 17, 68);">'Get %s from queue.'</span> % value)

<span style="color:rgb(51, 51, 51);font-weight:bold;">if</span> __name__==<span style="color:rgb(221, 17, 68);">'__main__'</span>:
    <span style="color:rgb(153, 153, 136);font-style:italic;"># 父进程创建Queue，并传给各个子进程：</span>
    q = Queue()
    pw = Process(target=write, args=(q,))
    pr = Process(target=read, args=(q,))
    <span style="color:rgb(153, 153, 136);font-style:italic;"># 启动子进程pw，写入:</span>
    pw.start()
    <span style="color:rgb(153, 153, 136);font-style:italic;"># 启动子进程pr，读取:</span>
    pr.start()
    <span style="color:rgb(153, 153, 136);font-style:italic;"># 等待pw结束:</span>
    pw.join()
    <span style="color:rgb(153, 153, 136);font-style:italic;"># pr进程里是死循环，无法等待其结束，只能强行终止:</span>
    pr.terminate()
</code></pre>
<p style="margin:0px 0px 15px;margin-top:15px;">运行结果如下：</p>
<pre style="margin:0px 0px 15px;margin-top:15px;padding:10px;background:rgb(250, 250, 250);font:12px/18px Consolas, monospace, serif;color:rgb(68, 68, 68);tab-size:4;overflow:auto;border:1px solid rgb(221, 221, 221);border-radius:3px;"><code style="white-space:pre-wrap;">Process to write: <span style="color:rgb(0, 153, 153);">50563</span>
Put A to queue...
Process to read: <span style="color:rgb(0, 153, 153);">50564</span>
Get A <span style="color:rgb(51, 51, 51);font-weight:bold;">from</span> queue.
Put B to queue...
Get B <span style="color:rgb(51, 51, 51);font-weight:bold;">from</span> queue.
Put C to queue...
Get C <span style="color:rgb(51, 51, 51);font-weight:bold;">from</span> queue.
</code></pre>
<p style="margin:0px 0px 15px;margin-top:15px;">在Unix/Linux下，<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">multiprocessing</code>模块封装了<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">fork()</code>调用，使我们不需要关注<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">fork()</code>的细节。由于Windows没有<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">fork</code>调用，因此，<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">multiprocessing</code>需要“模拟”出<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">fork</code>的效果，父进程所有Python对象都必须通过pickle序列化再传到子进程去，所有，如果<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">multiprocessing</code>在Windows下调用失败了，要先考虑是不是pickle失败了。</p>
<h3 style="margin:0px 0px 15px;font-family:&quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-weight:normal;color:rgb(68, 68, 68);text-transform:none;margin-top:25px;font-size:18px;line-height:24px;">小结</h3>
<p style="margin:0px 0px 15px;margin-top:15px;">在Unix/Linux下，可以使用<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">fork()</code>调用实现多进程。</p>
<p style="margin:0px 0px 15px;margin-top:15px;">要实现跨平台的多进程，可以使用<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">multiprocessing</code>模块。</p>
<p style="margin:0px 0px 15px;margin-top:15px;">进程间通信是通过<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">Queue</code>、<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">Pipes</code>等实现的。</p>
<h3 style="margin:0px 0px 15px;font-family:&quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-weight:normal;color:rgb(68, 68, 68);text-transform:none;margin-top:25px;font-size:18px;line-height:24px;">参考源码</h3>
<p style="margin:0px 0px 15px;margin-top:15px;"><a href="https://github.com/michaelliao/learn-python3/blob/master/samples/multitask/do_folk.py" style="background:transparent;color:rgb(5, 147, 211);text-decoration:none;cursor:pointer;" target="_blank">do_folk.py</a></p>
<p style="margin:0px 0px 15px;margin-top:15px;"><a href="https://github.com/michaelliao/learn-python3/blob/master/samples/multitask/multi_processing.py" style="background:transparent;color:rgb(5, 147, 211);text-decoration:none;cursor:pointer;" target="_blank">multi_processing.py</a></p>
<p style="margin:0px 0px 15px;margin-top:15px;"><a href="https://github.com/michaelliao/learn-python3/blob/master/samples/multitask/pooled_processing.py" style="background:transparent;color:rgb(5, 147, 211);text-decoration:none;cursor:pointer;" target="_blank">pooled_processing.py</a></p>
<p style="margin:0px 0px 15px;margin-top:15px;"><a href="https://github.com/michaelliao/learn-python3/blob/master/samples/multitask/do_subprocess.py" style="background:transparent;color:rgb(5, 147, 211);text-decoration:none;cursor:pointer;" target="_blank">do_subprocess.py</a></p>
<p style="margin:0px 0px 15px;margin-top:15px;"><a href="https://github.com/michaelliao/learn-python3/blob/master/samples/multitask/do_queue.py" style="background:transparent;color:rgb(5, 147, 211);text-decoration:none;cursor:pointer;" target="_blank">do_queue.py</a></p>
</div><h3 style="margin:0px 0px 15px;font-family:&quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-weight:normal;color:rgb(68, 68, 68);text-transform:none;margin-top:25px;font-size:18px;line-height:24px;">读后有收获可以支付宝请作者喝咖啡，读后有疑问请加微信群讨论：</h3><p style="margin:0px 0px 15px;margin-top:15px;"><img src="多进程_files/0" type="image/png" data-filename="0" height="220" style="vertical-align:middle;max-width:100%;height:auto;box-sizing:border-box;border:0px;" width="220"/> <img src="多进程_files/0 [1]" type="image/jpeg" data-filename="0" height="220" style="vertical-align:middle;max-width:100%;height:auto;box-sizing:border-box;border:0px;" width="220"/></p><h3 style="margin:0px 0px 15px;font-family:&quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-weight:normal;color:rgb(68, 68, 68);text-transform:none;margin-top:25px;font-size:18px;line-height:24px;">还可以分享给朋友：</h3><p style="margin:0px 0px 15px;margin-top:15px;"><a href="https://www.liaoxuefeng.com/wiki/1016959663602400/1017628290184064#0" style="-webkit-appearance:none;margin:0px;overflow:visible;font-style:inherit;font-variant:inherit;font-weight:inherit;font-stretch:inherit;font-family:inherit;text-transform:none;display:inline-block;box-sizing:border-box;padding:0px 12px;vertical-align:middle;line-height:28px;min-height:30px;font-size:14px;text-align:center;border:1px solid rgba(0, 0, 0, 0.06);border-radius:4px;background:rgb(245, 245, 245);text-decoration:none;background-color:rgb(218, 49, 75);color:rgb(255, 255, 255);box-shadow:rgba(0, 0, 0, 0.05) 0px 0px 5px inset;text-shadow:rgba(0, 0, 0, 0.1) 0px -1px 0px;cursor:pointer;"><i style="font-family:FontAwesome;display:inline-block;font-weight:normal;font-style:normal;line-height:1;-webkit-font-smoothing:antialiased;text-decoration:none;"><span style="font-family:FontAwesome;font-weight:normal;font-style:normal;line-height:1;"></span></i> 分享到微博</a></p>

    <hr style="box-sizing:content-box;height:0px;margin:15px 0px;border-width:1px 0px 0px;border-right-style:initial;border-bottom-style:initial;border-left-style:initial;border-right-color:initial;border-bottom-color:initial;border-left-color:initial;border-image:initial;border-top-style:solid;border-top-color:rgb(221, 221, 221);"/>

    <div style="padding-left:15px;padding-right:15px;"><span style="display:table-cell;"></span><a href="https://www.liaoxuefeng.com/wiki/1016959663602400/1017627212385376" style="background:transparent;color:rgb(5, 147, 211);text-decoration:none;cursor:pointer;"><i style="font-family:FontAwesome;display:inline-block;font-weight:normal;font-style:normal;line-height:1;-webkit-font-smoothing:antialiased;text-decoration:none;"><span style="font-family:FontAwesome;font-weight:normal;font-style:normal;line-height:1;"></span></i> 上一页</a><a href="https://www.liaoxuefeng.com/wiki/1016959663602400/1017629247922688" style="background:transparent;color:rgb(5, 147, 211);text-decoration:none;cursor:pointer;float:right;max-width:100%;">下一页 <i style="font-family:FontAwesome;display:inline-block;font-weight:normal;font-style:normal;line-height:1;-webkit-font-smoothing:antialiased;text-decoration:none;"><span style="font-family:FontAwesome;font-weight:normal;font-style:normal;line-height:1;"></span></i></a><span style="display:table;clear:both;"></span></div><hr style="box-sizing:content-box;height:0px;margin:15px 0px;border-width:1px 0px 0px;border-right-style:initial;border-bottom-style:initial;border-left-style:initial;border-right-color:initial;border-bottom-color:initial;border-left-color:initial;border-image:initial;border-top-style:solid;border-top-color:rgb(221, 221, 221);"/>

    <div style="position:relative;"><a name="comments" style="background:transparent;color:rgb(5, 147, 211);text-decoration:none;cursor:pointer;position:absolute;top:-65px;"></a></div>
							</div></div></div></div></div></div></div></div></div></div>
</div>
</span>
</div></body></html> 