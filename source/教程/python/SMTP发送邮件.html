<html>
<head>
  <title>SMTP发送邮件</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600753 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="2138"/>
<h1>SMTP发送邮件</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2019/9/3 21:28</i></td></tr>
</table>
</div>
<br/>

<div><span>
  <div style="--en-clipped-content:article">
<div><br/></div><div style="font-size: 16px; display:block; min-width: 100%; position: relative;"> <div style="font:14px/20px &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;text-size-adjust:100%;background:rgb(255, 255, 255);color:rgb(68, 68, 68);"><div style="font-family:&quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:14px;line-height:20px;color:rgb(102, 102, 102);background-color:rgb(255, 255, 255);"><div><div style="box-sizing:border-box;"><div style="list-style:none;"><div style="box-sizing:border-box;"><div><div><div>
								    <h4 style="margin:0px 0px 15px;font-family:&quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-weight:normal;color:rgb(68, 68, 68);text-transform:none;font-size:16px;line-height:22px;">SMTP发送邮件</h4>
    <div>
    	<span>阅读: 649660</span>
    	</div>

    <hr style="box-sizing:content-box;height:0px;margin:15px 0px;border-width:1px 0px 0px;border-right-style:initial;border-bottom-style:initial;border-left-style:initial;border-right-color:initial;border-bottom-color:initial;border-left-color:initial;border-image:initial;border-top-style:solid;border-top-color:rgb(221, 221, 221);"/>

    <div><p style="margin:0px 0px 15px;">SMTP是发送邮件的协议，Python内置对SMTP的支持，可以发送纯文本邮件、HTML邮件以及带附件的邮件。</p>
<p style="margin:0px 0px 15px;margin-top:15px;">Python对SMTP支持有<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">smtplib</code>和<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">email</code>两个模块，<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">email</code>负责构造邮件，<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">smtplib</code>负责发送邮件。</p>
<p style="margin:0px 0px 15px;margin-top:15px;">首先，我们来构造一个最简单的纯文本邮件：</p>
<pre style="margin:0px 0px 15px;margin-top:15px;padding:10px;background:rgb(250, 250, 250);font:12px/18px Consolas, monospace, serif;color:rgb(68, 68, 68);tab-size:4;overflow:auto;border:1px solid rgb(221, 221, 221);border-radius:3px;"><code style="white-space:pre-wrap;"><span style="color:rgb(51, 51, 51);font-weight:bold;">from</span> email.mime.text <span style="color:rgb(51, 51, 51);font-weight:bold;">import</span> MIMEText
msg = MIMEText(<span style="color:rgb(221, 17, 68);">'hello, send by Python...'</span>, <span style="color:rgb(221, 17, 68);">'plain'</span>, <span style="color:rgb(221, 17, 68);">'utf-8'</span>)
</code></pre>
<p style="margin:0px 0px 15px;margin-top:15px;">注意到构造<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">MIMEText</code>对象时，第一个参数就是邮件正文，第二个参数是MIME的subtype，传入<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">'plain'</code>表示纯文本，最终的MIME就是<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">'text/plain'</code>，最后一定要用<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">utf-8</code>编码保证多语言兼容性。</p>
<p style="margin:0px 0px 15px;margin-top:15px;">然后，通过SMTP发出去：</p>
<pre style="margin:0px 0px 15px;margin-top:15px;padding:10px;background:rgb(250, 250, 250);font:12px/18px Consolas, monospace, serif;color:rgb(68, 68, 68);tab-size:4;overflow:auto;border:1px solid rgb(221, 221, 221);border-radius:3px;"><code style="white-space:pre-wrap;"><span style="color:rgb(153, 153, 136);font-style:italic;"># 输入Email地址和口令:</span>
from_addr = input(<span style="color:rgb(221, 17, 68);">'From: '</span>)
password = input(<span style="color:rgb(221, 17, 68);">'Password: '</span>)
<span style="color:rgb(153, 153, 136);font-style:italic;"># 输入收件人地址:</span>
to_addr = input(<span style="color:rgb(221, 17, 68);">'To: '</span>)
<span style="color:rgb(153, 153, 136);font-style:italic;"># 输入SMTP服务器地址:</span>
smtp_server = input(<span style="color:rgb(221, 17, 68);">'SMTP server: '</span>)

<span style="color:rgb(51, 51, 51);font-weight:bold;">import</span> smtplib
server = smtplib.SMTP(smtp_server, <span style="color:rgb(0, 153, 153);">25</span>) <span style="color:rgb(153, 153, 136);font-style:italic;"># SMTP协议默认端口是25</span>
server.set_debuglevel(<span style="color:rgb(0, 153, 153);">1</span>)
server.login(from_addr, password)
server.sendmail(from_addr, [to_addr], msg.as_string())
server.quit()
</code></pre>
<p style="margin:0px 0px 15px;margin-top:15px;">我们用<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">set_debuglevel(1)</code>就可以打印出和SMTP服务器交互的所有信息。SMTP协议就是简单的文本命令和响应。<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">login()</code>方法用来登录SMTP服务器，<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">sendmail()</code>方法就是发邮件，由于可以一次发给多个人，所以传入一个<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">list</code>，邮件正文是一个<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">str</code>，<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">as_string()</code>把<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">MIMEText</code>对象变成<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">str</code>。</p>
<p style="margin:0px 0px 15px;margin-top:15px;">如果一切顺利，就可以在收件人信箱中收到我们刚发送的Email：</p>
<p style="margin:0px 0px 15px;margin-top:15px;"><img src="SMTP发送邮件_files/967446760519840" type="image/png" data-filename="967446760519840" height="162" style="vertical-align:middle;max-width:100%;height:auto;box-sizing:border-box;border:0px;" width="350"/></p>
<p style="margin:0px 0px 15px;margin-top:15px;">仔细观察，发现如下问题：</p>
<ol style="margin:0px 0px 15px;margin-top:15px;padding-left:30px;">
<li>邮件没有主题；</li>
<li>收件人的名字没有显示为友好的名字，比如<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">Mr Green &lt;green@example.com&gt;</code>；</li>
<li>明明收到了邮件，却提示不在收件人中。</li>
</ol>
<p style="margin:0px 0px 15px;margin-top:15px;">这是因为邮件主题、如何显示发件人、收件人等信息并不是通过SMTP协议发给MTA，而是包含在发给MTA的文本中的，所以，我们必须把<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">From</code>、<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">To</code>和<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">Subject</code>添加到<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">MIMEText</code>中，才是一封完整的邮件：</p>
<pre style="margin:0px 0px 15px;margin-top:15px;padding:10px;background:rgb(250, 250, 250);font:12px/18px Consolas, monospace, serif;color:rgb(68, 68, 68);tab-size:4;overflow:auto;border:1px solid rgb(221, 221, 221);border-radius:3px;"><code style="white-space:pre-wrap;"><span style="color:rgb(51, 51, 51);font-weight:bold;">from</span> email <span style="color:rgb(51, 51, 51);font-weight:bold;">import</span> encoders
<span style="color:rgb(51, 51, 51);font-weight:bold;">from</span> email.header <span style="color:rgb(51, 51, 51);font-weight:bold;">import</span> Header
<span style="color:rgb(51, 51, 51);font-weight:bold;">from</span> email.mime.text <span style="color:rgb(51, 51, 51);font-weight:bold;">import</span> MIMEText
<span style="color:rgb(51, 51, 51);font-weight:bold;">from</span> email.utils <span style="color:rgb(51, 51, 51);font-weight:bold;">import</span> parseaddr, formataddr

<span style="color:rgb(51, 51, 51);font-weight:bold;">import</span> smtplib
    
<span><span style="color:rgb(51, 51, 51);font-weight:bold;">def</span> <span style="color:rgb(153, 0, 0);font-weight:bold;">_format_addr</span><span>(s)</span>:</span>
    name, addr = parseaddr(s)
    <span style="color:rgb(51, 51, 51);font-weight:bold;">return</span> formataddr((Header(name, <span style="color:rgb(221, 17, 68);">'utf-8'</span>).encode(), addr))

from_addr = input(<span style="color:rgb(221, 17, 68);">'From: '</span>)
password = input(<span style="color:rgb(221, 17, 68);">'Password: '</span>)
to_addr = input(<span style="color:rgb(221, 17, 68);">'To: '</span>)
smtp_server = input(<span style="color:rgb(221, 17, 68);">'SMTP server: '</span>)

msg = MIMEText(<span style="color:rgb(221, 17, 68);">'hello, send by Python...'</span>, <span style="color:rgb(221, 17, 68);">'plain'</span>, <span style="color:rgb(221, 17, 68);">'utf-8'</span>)
msg[<span style="color:rgb(221, 17, 68);">'From'</span>] = _format_addr(<span style="color:rgb(221, 17, 68);">'Python爱好者 &lt;%s&gt;'</span> % from_addr)
msg[<span style="color:rgb(221, 17, 68);">'To'</span>] = _format_addr(<span style="color:rgb(221, 17, 68);">'管理员 &lt;%s&gt;'</span> % to_addr)
msg[<span style="color:rgb(221, 17, 68);">'Subject'</span>] = Header(<span style="color:rgb(221, 17, 68);">'来自SMTP的问候……'</span>, <span style="color:rgb(221, 17, 68);">'utf-8'</span>).encode()
    
server = smtplib.SMTP(smtp_server, <span style="color:rgb(0, 153, 153);">25</span>)
server.set_debuglevel(<span style="color:rgb(0, 153, 153);">1</span>)
server.login(from_addr, password)
server.sendmail(from_addr, [to_addr], msg.as_string())
server.quit()
</code></pre>
<p style="margin:0px 0px 15px;margin-top:15px;">我们编写了一个函数<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">_format_addr()</code>来格式化一个邮件地址。注意不能简单地传入<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">name &lt;addr@example.com&gt;</code>，因为如果包含中文，需要通过<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">Header</code>对象进行编码。</p>
<p style="margin:0px 0px 15px;margin-top:15px;"><code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">msg['To']</code>接收的是字符串而不是list，如果有多个邮件地址，用<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">,</code>分隔即可。</p>
<p style="margin:0px 0px 15px;margin-top:15px;">再发送一遍邮件，就可以在收件人邮箱中看到正确的标题、发件人和收件人：</p>
<p style="margin:0px 0px 15px;margin-top:15px;"><img src="SMTP发送邮件_files/967453175707264" type="image/png" data-filename="967453175707264" height="134" style="vertical-align:middle;max-width:100%;height:auto;box-sizing:border-box;border:0px;" width="300"/></p>
<p style="margin:0px 0px 15px;margin-top:15px;">你看到的收件人的名字很可能不是我们传入的<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">管理员</code>，因为很多邮件服务商在显示邮件时，会把收件人名字自动替换为用户注册的名字，但是其他收件人名字的显示不受影响。</p>
<p style="margin:0px 0px 15px;margin-top:15px;">如果我们查看Email的原始内容，可以看到如下经过编码的邮件头：</p>
<pre style="margin:0px 0px 15px;margin-top:15px;padding:10px;background:rgb(250, 250, 250);font:12px/18px Consolas, monospace, serif;color:rgb(68, 68, 68);tab-size:4;overflow:auto;border:1px solid rgb(221, 221, 221);border-radius:3px;"><code style="white-space:pre-wrap;"><span style="color:rgb(0, 153, 153);">From</span><span style="color:rgb(153, 0, 115);">:</span> =<span style="color:rgb(0, 153, 153);">?u</span>tf-<span style="color:rgb(0, 153, 153);">8</span><span style="color:rgb(0, 153, 153);">?b</span><span style="color:rgb(0, 153, 153);">?U</span>Hl0aG9u54ix5aW96ICF?= &lt;xxxxxx<span style="color:rgb(0, 128, 128);">@163</span>.com&gt;
<span style="color:rgb(0, 153, 153);">To</span><span style="color:rgb(153, 0, 115);">:</span> =<span style="color:rgb(0, 153, 153);">?u</span>tf-<span style="color:rgb(0, 153, 153);">8</span><span style="color:rgb(0, 153, 153);">?b</span><span style="color:rgb(0, 153, 153);">?5</span>66h55CG5ZGY?= &lt;xxxxxx<span style="color:rgb(0, 128, 128);">@qq</span>.com&gt;
<span style="color:rgb(0, 153, 153);">Subject</span><span style="color:rgb(153, 0, 115);">:</span> =<span style="color:rgb(0, 153, 153);">?u</span>tf-<span style="color:rgb(0, 153, 153);">8</span><span style="color:rgb(0, 153, 153);">?b</span><span style="color:rgb(0, 153, 153);">?5</span>p2l6IeqU01UUOeahOmXruWAmeKApuKApg==?=
</code></pre>
<p style="margin:0px 0px 15px;margin-top:15px;">这就是经过<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">Header</code>对象编码的文本，包含utf-8编码信息和Base64编码的文本。如果我们自己来手动构造这样的编码文本，显然比较复杂。</p>
<h3 style="margin:0px 0px 15px;font-family:&quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-weight:normal;color:rgb(68, 68, 68);text-transform:none;margin-top:25px;font-size:18px;line-height:24px;">发送HTML邮件</h3>
<p style="margin:0px 0px 15px;margin-top:15px;">如果我们要发送HTML邮件，而不是普通的纯文本文件怎么办？方法很简单，在构造<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">MIMEText</code>对象时，把HTML字符串传进去，再把第二个参数由<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">plain</code>变为<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">html</code>就可以了：</p>
<pre style="margin:0px 0px 15px;margin-top:15px;padding:10px;background:rgb(250, 250, 250);font:12px/18px Consolas, monospace, serif;color:rgb(68, 68, 68);tab-size:4;overflow:auto;border:1px solid rgb(221, 221, 221);border-radius:3px;"><code style="white-space:pre-wrap;">msg = MIMEText('<span style="color:rgb(0, 0, 128);font-weight:normal;">&lt;<span style="color:rgb(0, 0, 128);font-weight:normal;">html</span>&gt;</span><span style="color:rgb(0, 0, 128);font-weight:normal;">&lt;<span style="color:rgb(0, 0, 128);font-weight:normal;">body</span>&gt;</span><span style="color:rgb(0, 0, 128);font-weight:normal;">&lt;<span style="color:rgb(0, 0, 128);font-weight:normal;">h1</span>&gt;</span>Hello<span style="color:rgb(0, 0, 128);font-weight:normal;">&lt;/<span style="color:rgb(0, 0, 128);font-weight:normal;">h1</span>&gt;</span>' +
    '<span style="color:rgb(0, 0, 128);font-weight:normal;">&lt;<span style="color:rgb(0, 0, 128);font-weight:normal;">p</span>&gt;</span>send by <span style="color:rgb(0, 0, 128);font-weight:normal;">&lt;<span style="color:rgb(0, 0, 128);font-weight:normal;">a</span> <span style="color:rgb(0, 128, 128);">href</span>=<span style="color:rgb(221, 17, 68);">&quot;http://www.python.org&quot;</span>&gt;</span>Python<span style="color:rgb(0, 0, 128);font-weight:normal;">&lt;/<span style="color:rgb(0, 0, 128);font-weight:normal;">a</span>&gt;</span>...<span style="color:rgb(0, 0, 128);font-weight:normal;">&lt;/<span style="color:rgb(0, 0, 128);font-weight:normal;">p</span>&gt;</span>' +
    '<span style="color:rgb(0, 0, 128);font-weight:normal;">&lt;/<span style="color:rgb(0, 0, 128);font-weight:normal;">body</span>&gt;</span><span style="color:rgb(0, 0, 128);font-weight:normal;">&lt;/<span style="color:rgb(0, 0, 128);font-weight:normal;">html</span>&gt;</span>', 'html', 'utf-8')
</code></pre>
<p style="margin:0px 0px 15px;margin-top:15px;">再发送一遍邮件，你将看到以HTML显示的邮件：</p>
<p style="margin:0px 0px 15px;margin-top:15px;"><img src="SMTP发送邮件_files/967455607327072" type="image/png" data-filename="967455607327072" height="220" style="vertical-align:middle;max-width:100%;height:auto;box-sizing:border-box;border:0px;" width="300"/></p>
<h3 style="margin:0px 0px 15px;font-family:&quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-weight:normal;color:rgb(68, 68, 68);text-transform:none;margin-top:25px;font-size:18px;line-height:24px;">发送附件</h3>
<p style="margin:0px 0px 15px;margin-top:15px;">如果Email中要加上附件怎么办？带附件的邮件可以看做包含若干部分的邮件：文本和各个附件本身，所以，可以构造一个<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">MIMEMultipart</code>对象代表邮件本身，然后往里面加上一个<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">MIMEText</code>作为邮件正文，再继续往里面加上表示附件的<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">MIMEBase</code>对象即可：</p>
<pre style="margin:0px 0px 15px;margin-top:15px;padding:10px;background:rgb(250, 250, 250);font:12px/18px Consolas, monospace, serif;color:rgb(68, 68, 68);tab-size:4;overflow:auto;border:1px solid rgb(221, 221, 221);border-radius:3px;"><code style="white-space:pre-wrap;"><span style="color:rgb(153, 153, 136);font-style:italic;"># 邮件对象:</span>
msg = MIMEMultipart()
msg[<span style="color:rgb(221, 17, 68);">'From'</span>] = _format_addr(<span style="color:rgb(221, 17, 68);">'Python爱好者 &lt;%s&gt;'</span> % from_addr)
msg[<span style="color:rgb(221, 17, 68);">'To'</span>] = _format_addr(<span style="color:rgb(221, 17, 68);">'管理员 &lt;%s&gt;'</span> % to_addr)
msg[<span style="color:rgb(221, 17, 68);">'Subject'</span>] = Header(<span style="color:rgb(221, 17, 68);">'来自SMTP的问候……'</span>, <span style="color:rgb(221, 17, 68);">'utf-8'</span>).encode()

<span style="color:rgb(153, 153, 136);font-style:italic;"># 邮件正文是MIMEText:</span>
msg.attach(MIMEText(<span style="color:rgb(221, 17, 68);">'send with file...'</span>, <span style="color:rgb(221, 17, 68);">'plain'</span>, <span style="color:rgb(221, 17, 68);">'utf-8'</span>))

<span style="color:rgb(153, 153, 136);font-style:italic;"># 添加附件就是加上一个MIMEBase，从本地读取一个图片:</span>
<span style="color:rgb(51, 51, 51);font-weight:bold;">with</span> open(<span style="color:rgb(221, 17, 68);">'/Users/michael/Downloads/test.png'</span>, <span style="color:rgb(221, 17, 68);">'rb'</span>) <span style="color:rgb(51, 51, 51);font-weight:bold;">as</span> f:
    <span style="color:rgb(153, 153, 136);font-style:italic;"># 设置附件的MIME和文件名，这里是png类型:</span>
    mime = MIMEBase(<span style="color:rgb(221, 17, 68);">'image'</span>, <span style="color:rgb(221, 17, 68);">'png'</span>, filename=<span style="color:rgb(221, 17, 68);">'test.png'</span>)
    <span style="color:rgb(153, 153, 136);font-style:italic;"># 加上必要的头信息:</span>
    mime.add_header(<span style="color:rgb(221, 17, 68);">'Content-Disposition'</span>, <span style="color:rgb(221, 17, 68);">'attachment'</span>, filename=<span style="color:rgb(221, 17, 68);">'test.png'</span>)
    mime.add_header(<span style="color:rgb(221, 17, 68);">'Content-ID'</span>, <span style="color:rgb(221, 17, 68);">'&lt;0&gt;'</span>)
    mime.add_header(<span style="color:rgb(221, 17, 68);">'X-Attachment-Id'</span>, <span style="color:rgb(221, 17, 68);">'0'</span>)
    <span style="color:rgb(153, 153, 136);font-style:italic;"># 把附件的内容读进来:</span>
    mime.set_payload(f.read())
    <span style="color:rgb(153, 153, 136);font-style:italic;"># 用Base64编码:</span>
    encoders.encode_base64(mime)
    <span style="color:rgb(153, 153, 136);font-style:italic;"># 添加到MIMEMultipart:</span>
    msg.attach(mime)
</code></pre>
<p style="margin:0px 0px 15px;margin-top:15px;">然后，按正常发送流程把<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">msg</code>（注意类型已变为<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">MIMEMultipart</code>）发送出去，就可以收到如下带附件的邮件：</p>
<p style="margin:0px 0px 15px;margin-top:15px;"><img src="SMTP发送邮件_files/967464310443456" type="image/png" data-filename="967464310443456" height="420" style="vertical-align:middle;max-width:100%;height:auto;box-sizing:border-box;border:0px;" width="300"/></p>
<h3 style="margin:0px 0px 15px;font-family:&quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-weight:normal;color:rgb(68, 68, 68);text-transform:none;margin-top:25px;font-size:18px;line-height:24px;">发送图片</h3>
<p style="margin:0px 0px 15px;margin-top:15px;">如果要把一个图片嵌入到邮件正文中怎么做？直接在HTML邮件中链接图片地址行不行？答案是，大部分邮件服务商都会自动屏蔽带有外链的图片，因为不知道这些链接是否指向恶意网站。</p>
<p style="margin:0px 0px 15px;margin-top:15px;">要把图片嵌入到邮件正文中，我们只需按照发送附件的方式，先把邮件作为附件添加进去，然后，在HTML中通过引用<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">src=&quot;cid:0&quot;</code>就可以把附件作为图片嵌入了。如果有多个图片，给它们依次编号，然后引用不同的<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">cid:x</code>即可。</p>
<p style="margin:0px 0px 15px;margin-top:15px;">把上面代码加入<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">MIMEMultipart</code>的<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">MIMEText</code>从<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">plain</code>改为<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">html</code>，然后在适当的位置引用图片：</p>
<pre style="margin:0px 0px 15px;margin-top:15px;padding:10px;background:rgb(250, 250, 250);font:12px/18px Consolas, monospace, serif;color:rgb(68, 68, 68);tab-size:4;overflow:auto;border:1px solid rgb(221, 221, 221);border-radius:3px;"><code style="white-space:pre-wrap;">msg.attach(MIMEText('<span style="color:rgb(0, 0, 128);font-weight:normal;">&lt;<span style="color:rgb(0, 0, 128);font-weight:normal;">html</span>&gt;</span><span style="color:rgb(0, 0, 128);font-weight:normal;">&lt;<span style="color:rgb(0, 0, 128);font-weight:normal;">body</span>&gt;</span><span style="color:rgb(0, 0, 128);font-weight:normal;">&lt;<span style="color:rgb(0, 0, 128);font-weight:normal;">h1</span>&gt;</span>Hello<span style="color:rgb(0, 0, 128);font-weight:normal;">&lt;/<span style="color:rgb(0, 0, 128);font-weight:normal;">h1</span>&gt;</span>' +
    '<span style="color:rgb(0, 0, 128);font-weight:normal;">&lt;<span style="color:rgb(0, 0, 128);font-weight:normal;">p</span>&gt;</span><span style="color:rgb(0, 0, 128);font-weight:normal;">&lt;<span style="color:rgb(0, 0, 128);font-weight:normal;">img</span> <span style="color:rgb(0, 128, 128);">src</span>=<span style="color:rgb(221, 17, 68);">&quot;cid:0&quot;</span>&gt;</span><span style="color:rgb(0, 0, 128);font-weight:normal;">&lt;/<span style="color:rgb(0, 0, 128);font-weight:normal;">p</span>&gt;</span>' +
    '<span style="color:rgb(0, 0, 128);font-weight:normal;">&lt;/<span style="color:rgb(0, 0, 128);font-weight:normal;">body</span>&gt;</span><span style="color:rgb(0, 0, 128);font-weight:normal;">&lt;/<span style="color:rgb(0, 0, 128);font-weight:normal;">html</span>&gt;</span>', 'html', 'utf-8'))
</code></pre>
<p style="margin:0px 0px 15px;margin-top:15px;">再次发送，就可以看到图片直接嵌入到邮件正文的效果：</p>
<p style="margin:0px 0px 15px;margin-top:15px;"><img src="SMTP发送邮件_files/967488004941504" type="image/png" data-filename="967488004941504" height="448" style="vertical-align:middle;max-width:100%;height:auto;box-sizing:border-box;border:0px;" width="300"/></p>
<h3 style="margin:0px 0px 15px;font-family:&quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-weight:normal;color:rgb(68, 68, 68);text-transform:none;margin-top:25px;font-size:18px;line-height:24px;">同时支持HTML和Plain格式</h3>
<p style="margin:0px 0px 15px;margin-top:15px;">如果我们发送HTML邮件，收件人通过浏览器或者Outlook之类的软件是可以正常浏览邮件内容的，但是，如果收件人使用的设备太古老，查看不了HTML邮件怎么办？</p>
<p style="margin:0px 0px 15px;margin-top:15px;">办法是在发送HTML的同时再附加一个纯文本，如果收件人无法查看HTML格式的邮件，就可以自动降级查看纯文本邮件。</p>
<p style="margin:0px 0px 15px;margin-top:15px;">利用<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">MIMEMultipart</code>就可以组合一个HTML和Plain，要注意指定subtype是<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">alternative</code>：</p>
<pre style="margin:0px 0px 15px;margin-top:15px;padding:10px;background:rgb(250, 250, 250);font:12px/18px Consolas, monospace, serif;color:rgb(68, 68, 68);tab-size:4;overflow:auto;border:1px solid rgb(221, 221, 221);border-radius:3px;"><code style="white-space:pre-wrap;">msg = MIMEMultipart('alternative')
msg['From'] = ...
msg['To'] = ...
msg['Subject'] = ...

msg.attach(MIMEText('hello', 'plain', 'utf-8'))
msg.attach(MIMEText('<span style="color:rgb(0, 0, 128);font-weight:normal;">&lt;<span style="color:rgb(0, 0, 128);font-weight:normal;">html</span>&gt;</span><span style="color:rgb(0, 0, 128);font-weight:normal;">&lt;<span style="color:rgb(0, 0, 128);font-weight:normal;">body</span>&gt;</span><span style="color:rgb(0, 0, 128);font-weight:normal;">&lt;<span style="color:rgb(0, 0, 128);font-weight:normal;">h1</span>&gt;</span>Hello<span style="color:rgb(0, 0, 128);font-weight:normal;">&lt;/<span style="color:rgb(0, 0, 128);font-weight:normal;">h1</span>&gt;</span><span style="color:rgb(0, 0, 128);font-weight:normal;">&lt;/<span style="color:rgb(0, 0, 128);font-weight:normal;">body</span>&gt;</span><span style="color:rgb(0, 0, 128);font-weight:normal;">&lt;/<span style="color:rgb(0, 0, 128);font-weight:normal;">html</span>&gt;</span>', 'html', 'utf-8'))
# 正常发送msg对象...
</code></pre>
<h3 style="margin:0px 0px 15px;font-family:&quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-weight:normal;color:rgb(68, 68, 68);text-transform:none;margin-top:25px;font-size:18px;line-height:24px;">加密SMTP</h3>
<p style="margin:0px 0px 15px;margin-top:15px;">使用标准的25端口连接SMTP服务器时，使用的是明文传输，发送邮件的整个过程可能会被窃听。要更安全地发送邮件，可以加密SMTP会话，实际上就是先创建SSL安全连接，然后再使用SMTP协议发送邮件。</p>
<p style="margin:0px 0px 15px;margin-top:15px;">某些邮件服务商，例如Gmail，提供的SMTP服务必须要加密传输。我们来看看如何通过Gmail提供的安全SMTP发送邮件。</p>
<p style="margin:0px 0px 15px;margin-top:15px;">必须知道，Gmail的SMTP端口是587，因此，修改代码如下：</p>
<pre style="margin:0px 0px 15px;margin-top:15px;padding:10px;background:rgb(250, 250, 250);font:12px/18px Consolas, monospace, serif;color:rgb(68, 68, 68);tab-size:4;overflow:auto;border:1px solid rgb(221, 221, 221);border-radius:3px;"><code style="white-space:pre-wrap;">smtp_server = <span style="color:rgb(221, 17, 68);">'smtp.gmail.com'</span>
smtp_port = <span style="color:rgb(0, 153, 153);">587</span>
server = smtplib.<span style="color:rgb(0, 153, 153);">SMTP</span>(smtp_server, smtp_port)
server.starttls()
<span style="color:rgb(153, 153, 136);font-style:italic;"># 剩下的代码和前面的一模一样:</span>
server.set_debuglevel(<span style="color:rgb(0, 153, 153);">1</span>)
...
</code></pre>
<p style="margin:0px 0px 15px;margin-top:15px;">只需要在创建<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">SMTP</code>对象后，立刻调用<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">starttls()</code>方法，就创建了安全连接。后面的代码和前面的发送邮件代码完全一样。</p>
<p style="margin:0px 0px 15px;margin-top:15px;">如果因为网络问题无法连接Gmail的SMTP服务器，请相信我们的代码是没有问题的，你需要对你的网络设置做必要的调整。</p>
<h3 style="margin:0px 0px 15px;font-family:&quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-weight:normal;color:rgb(68, 68, 68);text-transform:none;margin-top:25px;font-size:18px;line-height:24px;">小结</h3>
<p style="margin:0px 0px 15px;margin-top:15px;">使用Python的smtplib发送邮件十分简单，只要掌握了各种邮件类型的构造方法，正确设置好邮件头，就可以顺利发出。</p>
<p style="margin:0px 0px 15px;margin-top:15px;">构造一个邮件对象就是一个<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">Messag</code>对象，如果构造一个<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">MIMEText</code>对象，就表示一个文本邮件对象，如果构造一个<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">MIMEImage</code>对象，就表示一个作为附件的图片，要把多个对象组合起来，就用<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">MIMEMultipart</code>对象，而<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">MIMEBase</code>可以表示任何对象。它们的继承关系如下：</p>
<pre style="margin:0px 0px 15px;margin-top:15px;padding:10px;background:rgb(250, 250, 250);font:12px/18px Consolas, monospace, serif;color:rgb(68, 68, 68);tab-size:4;overflow:auto;border:1px solid rgb(221, 221, 221);border-radius:3px;"><code style="white-space:pre-wrap;">Message
+- MIMEBase
   +- MIMEMultipart
   +- MIMENonMultipart
      +- MIMEMessage
      +- MIMEText
      +- MIMEImage
</code></pre>
<p style="margin:0px 0px 15px;margin-top:15px;">这种嵌套关系就可以构造出任意复杂的邮件。你可以通过<a href="https://docs.python.org/3/library/email.mime.html" style="background:transparent;color:rgb(5, 147, 211);text-decoration:none;cursor:pointer;" target="_blank">email.mime文档</a>查看它们所在的包以及详细的用法。</p>
<h3 style="margin:0px 0px 15px;font-family:&quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-weight:normal;color:rgb(68, 68, 68);text-transform:none;margin-top:25px;font-size:18px;line-height:24px;">参考源码</h3>
<p style="margin:0px 0px 15px;margin-top:15px;"><a href="https://github.com/michaelliao/learn-python3/blob/master/samples/mail/send_mail.py" style="background:transparent;color:rgb(5, 147, 211);text-decoration:none;cursor:pointer;" target="_blank">send_mail.py</a></p>
</div><h3 style="margin:0px 0px 15px;font-family:&quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-weight:normal;color:rgb(68, 68, 68);text-transform:none;margin-top:25px;font-size:18px;line-height:24px;">读后有收获可以支付宝请作者喝咖啡，读后有疑问请加微信群讨论：</h3><p style="margin:0px 0px 15px;margin-top:15px;"><img src="SMTP发送邮件_files/0" type="image/png" data-filename="0" height="220" style="vertical-align:middle;max-width:100%;height:auto;box-sizing:border-box;border:0px;" width="220"/> <img src="SMTP发送邮件_files/0 [1]" type="image/jpeg" data-filename="0" height="220" style="vertical-align:middle;max-width:100%;height:auto;box-sizing:border-box;border:0px;" width="220"/></p><h3 style="margin:0px 0px 15px;font-family:&quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-weight:normal;color:rgb(68, 68, 68);text-transform:none;margin-top:25px;font-size:18px;line-height:24px;">还可以分享给朋友：</h3><p style="margin:0px 0px 15px;margin-top:15px;"><a href="https://www.liaoxuefeng.com/wiki/1016959663602400/1017790702398272#0" style="-webkit-appearance:none;margin:0px;overflow:visible;font-style:inherit;font-variant:inherit;font-weight:inherit;font-stretch:inherit;font-family:inherit;text-transform:none;display:inline-block;box-sizing:border-box;padding:0px 12px;vertical-align:middle;line-height:28px;min-height:30px;font-size:14px;text-align:center;border:1px solid rgba(0, 0, 0, 0.06);border-radius:4px;background:rgb(245, 245, 245);text-decoration:none;background-color:rgb(218, 49, 75);color:rgb(255, 255, 255);box-shadow:rgba(0, 0, 0, 0.05) 0px 0px 5px inset;text-shadow:rgba(0, 0, 0, 0.1) 0px -1px 0px;cursor:pointer;"><i style="font-family:FontAwesome;display:inline-block;font-weight:normal;font-style:normal;line-height:1;-webkit-font-smoothing:antialiased;text-decoration:none;"><span style="font-family:FontAwesome;font-weight:normal;font-style:normal;line-height:1;"></span></i> 分享到微博</a></p>

    <hr style="box-sizing:content-box;height:0px;margin:15px 0px;border-width:1px 0px 0px;border-right-style:initial;border-bottom-style:initial;border-left-style:initial;border-right-color:initial;border-bottom-color:initial;border-left-color:initial;border-image:initial;border-top-style:solid;border-top-color:rgb(221, 221, 221);"/>

    <div style="padding-left:15px;padding-right:15px;"><span style="display:table-cell;"></span><a href="https://www.liaoxuefeng.com/wiki/1016959663602400/1017790556023936" style="background:transparent;color:rgb(5, 147, 211);text-decoration:none;cursor:pointer;"><i style="font-family:FontAwesome;display:inline-block;font-weight:normal;font-style:normal;line-height:1;-webkit-font-smoothing:antialiased;text-decoration:none;"><span style="font-family:FontAwesome;font-weight:normal;font-style:normal;line-height:1;"></span></i> 上一页</a><a href="https://www.liaoxuefeng.com/wiki/1016959663602400/1017800447489504" style="background:transparent;color:rgb(5, 147, 211);text-decoration:none;cursor:pointer;float:right;max-width:100%;">下一页 <i style="font-family:FontAwesome;display:inline-block;font-weight:normal;font-style:normal;line-height:1;-webkit-font-smoothing:antialiased;text-decoration:none;"><span style="font-family:FontAwesome;font-weight:normal;font-style:normal;line-height:1;"></span></i></a><span style="display:table;clear:both;"></span></div><hr style="box-sizing:content-box;height:0px;margin:15px 0px;border-width:1px 0px 0px;border-right-style:initial;border-bottom-style:initial;border-left-style:initial;border-right-color:initial;border-bottom-color:initial;border-left-color:initial;border-image:initial;border-top-style:solid;border-top-color:rgb(221, 221, 221);"/>

    <div style="position:relative;"><a name="comments" style="background:transparent;color:rgb(5, 147, 211);text-decoration:none;cursor:pointer;position:absolute;top:-65px;"></a></div>
							</div></div></div></div></div></div></div></div></div></div>
</div>
</span>
</div></body></html> 