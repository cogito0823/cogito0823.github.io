<html>
<head>
  <title>协程</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600753 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="2372"/>
<h1>协程</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2019/9/3 21:32</i></td></tr>
</table>
</div>
<br/>

<div><span>
  <div style="--en-clipped-content:article">
<div><br/></div><div style="font-size: 16px; display:block; min-width: 100%; position: relative;"> <div style="font:14px/20px &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;text-size-adjust:100%;background:rgb(255, 255, 255);color:rgb(68, 68, 68);"><div style="font-family:&quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:14px;line-height:20px;color:rgb(102, 102, 102);background-color:rgb(255, 255, 255);"><div><div style="box-sizing:border-box;"><div style="list-style:none;"><div style="box-sizing:border-box;"><div><div><div>
								    <h4 style="margin:0px 0px 15px;font-family:&quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-weight:normal;color:rgb(68, 68, 68);text-transform:none;font-size:16px;line-height:22px;">协程</h4>
    <div>
    	<span>阅读: 1812302</span>
    	</div>

    <hr style="box-sizing:content-box;height:0px;margin:15px 0px;border-width:1px 0px 0px;border-right-style:initial;border-bottom-style:initial;border-left-style:initial;border-right-color:initial;border-bottom-color:initial;border-left-color:initial;border-image:initial;border-top-style:solid;border-top-color:rgb(221, 221, 221);"/>

    <div><p style="margin:0px 0px 15px;">在学习异步IO模型前，我们先来了解协程。</p>
<p style="margin:0px 0px 15px;margin-top:15px;">协程，又称微线程，纤程。英文名Coroutine。</p>
<p style="margin:0px 0px 15px;margin-top:15px;">协程的概念很早就提出来了，但直到最近几年才在某些语言（如Lua）中得到广泛应用。</p>
<p style="margin:0px 0px 15px;margin-top:15px;">子程序，或者称为函数，在所有语言中都是层级调用，比如A调用B，B在执行过程中又调用了C，C执行完毕返回，B执行完毕返回，最后是A执行完毕。</p>
<p style="margin:0px 0px 15px;margin-top:15px;">所以子程序调用是通过栈实现的，一个线程就是执行一个子程序。</p>
<p style="margin:0px 0px 15px;margin-top:15px;">子程序调用总是一个入口，一次返回，调用顺序是明确的。而协程的调用和子程序不同。</p>
<p style="margin:0px 0px 15px;margin-top:15px;">协程看上去也是子程序，但执行过程中，在子程序内部可中断，然后转而执行别的子程序，在适当的时候再返回来接着执行。</p>
<p style="margin:0px 0px 15px;margin-top:15px;">注意，在一个子程序中中断，去执行其他子程序，不是函数调用，有点类似CPU的中断。比如子程序A、B：</p>
<pre style="margin:0px 0px 15px;margin-top:15px;padding:10px;background:rgb(250, 250, 250);font:12px/18px Consolas, monospace, serif;color:rgb(68, 68, 68);tab-size:4;overflow:auto;border:1px solid rgb(221, 221, 221);border-radius:3px;"><code style="white-space:pre-wrap;"><span><span style="color:rgb(51, 51, 51);font-weight:bold;">def</span> <span style="color:rgb(153, 0, 0);font-weight:bold;">A</span><span>()</span>:</span>
    print(<span style="color:rgb(221, 17, 68);">'1'</span>)
    print(<span style="color:rgb(221, 17, 68);">'2'</span>)
    print(<span style="color:rgb(221, 17, 68);">'3'</span>)

<span><span style="color:rgb(51, 51, 51);font-weight:bold;">def</span> <span style="color:rgb(153, 0, 0);font-weight:bold;">B</span><span>()</span>:</span>
    print(<span style="color:rgb(221, 17, 68);">'x'</span>)
    print(<span style="color:rgb(221, 17, 68);">'y'</span>)
    print(<span style="color:rgb(221, 17, 68);">'z'</span>)
</code></pre>
<p style="margin:0px 0px 15px;margin-top:15px;">假设由协程执行，在执行A的过程中，可以随时中断，去执行B，B也可能在执行过程中中断再去执行A，结果可能是：</p>
<pre style="margin:0px 0px 15px;margin-top:15px;padding:10px;background:rgb(250, 250, 250);font:12px/18px Consolas, monospace, serif;color:rgb(68, 68, 68);tab-size:4;overflow:auto;border:1px solid rgb(221, 221, 221);border-radius:3px;"><code style="white-space:pre-wrap;">1
2
x
y
3
z
</code></pre>
<p style="margin:0px 0px 15px;margin-top:15px;">但是在A中是没有调用B的，所以协程的调用比函数调用理解起来要难一些。</p>
<p style="margin:0px 0px 15px;margin-top:15px;">看起来A、B的执行有点像多线程，但协程的特点在于是一个线程执行，那和多线程比，协程有何优势？</p>
<p style="margin:0px 0px 15px;margin-top:15px;">最大的优势就是协程极高的执行效率。因为子程序切换不是线程切换，而是由程序自身控制，因此，没有线程切换的开销，和多线程比，线程数量越多，协程的性能优势就越明显。</p>
<p style="margin:0px 0px 15px;margin-top:15px;">第二大优势就是不需要多线程的锁机制，因为只有一个线程，也不存在同时写变量冲突，在协程中控制共享资源不加锁，只需要判断状态就好了，所以执行效率比多线程高很多。</p>
<p style="margin:0px 0px 15px;margin-top:15px;">因为协程是一个线程执行，那怎么利用多核CPU呢？最简单的方法是多进程+协程，既充分利用多核，又充分发挥协程的高效率，可获得极高的性能。</p>
<p style="margin:0px 0px 15px;margin-top:15px;">Python对协程的支持是通过generator实现的。</p>
<p style="margin:0px 0px 15px;margin-top:15px;">在generator中，我们不但可以通过<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">for</code>循环来迭代，还可以不断调用<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">next()</code>函数获取由<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">yield</code>语句返回的下一个值。</p>
<p style="margin:0px 0px 15px;margin-top:15px;">但是Python的<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">yield</code>不但可以返回一个值，它还可以接收调用者发出的参数。</p>
<p style="margin:0px 0px 15px;margin-top:15px;">来看例子：</p>
<p style="margin:0px 0px 15px;margin-top:15px;">传统的生产者-消费者模型是一个线程写消息，一个线程取消息，通过锁机制控制队列和等待，但一不小心就可能死锁。</p>
<p style="margin:0px 0px 15px;margin-top:15px;">如果改用协程，生产者生产消息后，直接通过<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">yield</code>跳转到消费者开始执行，待消费者执行完毕后，切换回生产者继续生产，效率极高：</p>
<pre style="margin:0px 0px 15px;margin-top:15px;padding:10px;background:rgb(250, 250, 250);font:12px/18px Consolas, monospace, serif;color:rgb(68, 68, 68);tab-size:4;overflow:auto;border:1px solid rgb(221, 221, 221);border-radius:3px;"><code style="white-space:pre-wrap;"><span><span style="color:rgb(51, 51, 51);font-weight:bold;">def</span> <span style="color:rgb(153, 0, 0);font-weight:bold;">consumer</span><span>()</span>:</span>
    r = <span style="color:rgb(221, 17, 68);">''</span>
    <span style="color:rgb(51, 51, 51);font-weight:bold;">while</span> <span style="color:rgb(0, 134, 179);">True</span>:
        n = <span style="color:rgb(51, 51, 51);font-weight:bold;">yield</span> r
        <span style="color:rgb(51, 51, 51);font-weight:bold;">if</span> <span style="color:rgb(51, 51, 51);font-weight:bold;">not</span> n:
            <span style="color:rgb(51, 51, 51);font-weight:bold;">return</span>
        print(<span style="color:rgb(221, 17, 68);">'[CONSUMER] Consuming %s...'</span> % n)
        r = <span style="color:rgb(221, 17, 68);">'200 OK'</span>

<span><span style="color:rgb(51, 51, 51);font-weight:bold;">def</span> <span style="color:rgb(153, 0, 0);font-weight:bold;">produce</span><span>(c)</span>:</span>
    c.send(<span style="color:rgb(0, 134, 179);">None</span>)
    n = <span style="color:rgb(0, 153, 153);">0</span>
    <span style="color:rgb(51, 51, 51);font-weight:bold;">while</span> n &lt; <span style="color:rgb(0, 153, 153);">5</span>:
        n = n + <span style="color:rgb(0, 153, 153);">1</span>
        print(<span style="color:rgb(221, 17, 68);">'[PRODUCER] Producing %s...'</span> % n)
        r = c.send(n)
        print(<span style="color:rgb(221, 17, 68);">'[PRODUCER] Consumer return: %s'</span> % r)
    c.close()

c = consumer()
produce(c)
</code></pre>
<p style="margin:0px 0px 15px;margin-top:15px;">执行结果：</p>
<pre style="margin:0px 0px 15px;margin-top:15px;padding:10px;background:rgb(250, 250, 250);font:12px/18px Consolas, monospace, serif;color:rgb(68, 68, 68);tab-size:4;overflow:auto;border:1px solid rgb(221, 221, 221);border-radius:3px;"><code style="white-space:pre-wrap;"><span>[PRODUCER]</span> <span style="color:rgb(0, 0, 128);font-weight:normal;">Producing</span> 1...
<span>[CONSUMER]</span> <span style="color:rgb(0, 0, 128);font-weight:normal;">Consuming</span> 1...
<span>[PRODUCER]</span> <span style="color:rgb(0, 0, 128);font-weight:normal;">Consumer</span> <span style="color:rgb(0, 0, 128);font-weight:normal;">return</span>: 200 <span style="color:rgb(0, 0, 128);font-weight:normal;">OK</span>
<span>[PRODUCER]</span> <span style="color:rgb(0, 0, 128);font-weight:normal;">Producing</span> 2...
<span>[CONSUMER]</span> <span style="color:rgb(0, 0, 128);font-weight:normal;">Consuming</span> 2...
<span>[PRODUCER]</span> <span style="color:rgb(0, 0, 128);font-weight:normal;">Consumer</span> <span style="color:rgb(0, 0, 128);font-weight:normal;">return</span>: 200 <span style="color:rgb(0, 0, 128);font-weight:normal;">OK</span>
<span>[PRODUCER]</span> <span style="color:rgb(0, 0, 128);font-weight:normal;">Producing</span> 3...
<span>[CONSUMER]</span> <span style="color:rgb(0, 0, 128);font-weight:normal;">Consuming</span> 3...
<span>[PRODUCER]</span> <span style="color:rgb(0, 0, 128);font-weight:normal;">Consumer</span> <span style="color:rgb(0, 0, 128);font-weight:normal;">return</span>: 200 <span style="color:rgb(0, 0, 128);font-weight:normal;">OK</span>
<span>[PRODUCER]</span> <span style="color:rgb(0, 0, 128);font-weight:normal;">Producing</span> 4...
<span>[CONSUMER]</span> <span style="color:rgb(0, 0, 128);font-weight:normal;">Consuming</span> 4...
<span>[PRODUCER]</span> <span style="color:rgb(0, 0, 128);font-weight:normal;">Consumer</span> <span style="color:rgb(0, 0, 128);font-weight:normal;">return</span>: 200 <span style="color:rgb(0, 0, 128);font-weight:normal;">OK</span>
<span>[PRODUCER]</span> <span style="color:rgb(0, 0, 128);font-weight:normal;">Producing</span> 5...
<span>[CONSUMER]</span> <span style="color:rgb(0, 0, 128);font-weight:normal;">Consuming</span> 5...
<span>[PRODUCER]</span> <span style="color:rgb(0, 0, 128);font-weight:normal;">Consumer</span> <span style="color:rgb(0, 0, 128);font-weight:normal;">return</span>: 200 <span style="color:rgb(0, 0, 128);font-weight:normal;">OK</span>
</code></pre>
<p style="margin:0px 0px 15px;margin-top:15px;">注意到<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">consumer</code>函数是一个<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">generator</code>，把一个<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">consumer</code>传入<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">produce</code>后：</p>
<ol style="margin:0px 0px 15px;margin-top:15px;padding-left:30px;">
<li>
<p style="margin:0px 0px 15px;">首先调用<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">c.send(None)</code>启动生成器；</p>
</li>
<li>
<p style="margin:0px 0px 15px;">然后，一旦生产了东西，通过<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">c.send(n)</code>切换到<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">consumer</code>执行；</p>
</li>
<li>
<p style="margin:0px 0px 15px;"><code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">consumer</code>通过<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">yield</code>拿到消息，处理，又通过<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">yield</code>把结果传回；</p>
</li>
<li>
<p style="margin:0px 0px 15px;"><code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">produce</code>拿到<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">consumer</code>处理的结果，继续生产下一条消息；</p>
</li>
<li>
<p style="margin:0px 0px 15px;"><code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">produce</code>决定不生产了，通过<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">c.close()</code>关闭<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">consumer</code>，整个过程结束。</p>
</li>
</ol>
<p style="margin:0px 0px 15px;margin-top:15px;">整个流程无锁，由一个线程执行，<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">produce</code>和<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">consumer</code>协作完成任务，所以称为“协程”，而非线程的抢占式多任务。</p>
<p style="margin:0px 0px 15px;margin-top:15px;">最后套用Donald Knuth的一句话总结协程的特点：</p>
<p style="margin:0px 0px 15px;margin-top:15px;">“子程序就是协程的一种特例。”</p>
<h3 style="margin:0px 0px 15px;font-family:&quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-weight:normal;color:rgb(68, 68, 68);text-transform:none;margin-top:25px;font-size:18px;line-height:24px;">参考源码</h3>
<p style="margin:0px 0px 15px;margin-top:15px;"><a href="https://github.com/michaelliao/learn-python3/blob/master/samples/async/coroutine.py" style="background:transparent;color:rgb(5, 147, 211);text-decoration:none;cursor:pointer;" target="_blank">coroutine.py</a></p>
</div><h3 style="margin:0px 0px 15px;font-family:&quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-weight:normal;color:rgb(68, 68, 68);text-transform:none;margin-top:25px;font-size:18px;line-height:24px;">读后有收获可以支付宝请作者喝咖啡，读后有疑问请加微信群讨论：</h3><p style="margin:0px 0px 15px;margin-top:15px;"><img src="协程_files/0" type="image/png" data-filename="0" height="220" style="vertical-align:middle;max-width:100%;height:auto;box-sizing:border-box;border:0px;" width="220"/> <img src="协程_files/0 [1]" type="image/jpeg" data-filename="0" height="220" style="vertical-align:middle;max-width:100%;height:auto;box-sizing:border-box;border:0px;" width="220"/></p><h3 style="margin:0px 0px 15px;font-family:&quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-weight:normal;color:rgb(68, 68, 68);text-transform:none;margin-top:25px;font-size:18px;line-height:24px;">还可以分享给朋友：</h3><p style="margin:0px 0px 15px;margin-top:15px;"><a href="https://www.liaoxuefeng.com/wiki/1016959663602400/1017968846697824#0" style="-webkit-appearance:none;margin:0px;overflow:visible;font-style:inherit;font-variant:inherit;font-weight:inherit;font-stretch:inherit;font-family:inherit;text-transform:none;display:inline-block;box-sizing:border-box;padding:0px 12px;vertical-align:middle;line-height:28px;min-height:30px;font-size:14px;text-align:center;border:1px solid rgba(0, 0, 0, 0.06);border-radius:4px;background:rgb(245, 245, 245);text-decoration:none;background-color:rgb(218, 49, 75);color:rgb(255, 255, 255);box-shadow:rgba(0, 0, 0, 0.05) 0px 0px 5px inset;text-shadow:rgba(0, 0, 0, 0.1) 0px -1px 0px;cursor:pointer;"><i style="font-family:FontAwesome;display:inline-block;font-weight:normal;font-style:normal;line-height:1;-webkit-font-smoothing:antialiased;text-decoration:none;"><span style="font-family:FontAwesome;font-weight:normal;font-style:normal;line-height:1;"></span></i> 分享到微博</a></p>

    <hr style="box-sizing:content-box;height:0px;margin:15px 0px;border-width:1px 0px 0px;border-right-style:initial;border-bottom-style:initial;border-left-style:initial;border-right-color:initial;border-bottom-color:initial;border-left-color:initial;border-image:initial;border-top-style:solid;border-top-color:rgb(221, 221, 221);"/>

    <div style="padding-left:15px;padding-right:15px;"><span style="display:table-cell;"></span><a href="https://www.liaoxuefeng.com/wiki/1016959663602400/1017959540289152" style="background:transparent;color:rgb(5, 147, 211);text-decoration:none;cursor:pointer;"><i style="font-family:FontAwesome;display:inline-block;font-weight:normal;font-style:normal;line-height:1;-webkit-font-smoothing:antialiased;text-decoration:none;"><span style="font-family:FontAwesome;font-weight:normal;font-style:normal;line-height:1;"></span></i> 上一页</a><a href="https://www.liaoxuefeng.com/wiki/1016959663602400/1017970488768640" style="background:transparent;color:rgb(5, 147, 211);text-decoration:none;cursor:pointer;float:right;max-width:100%;">下一页 <i style="font-family:FontAwesome;display:inline-block;font-weight:normal;font-style:normal;line-height:1;-webkit-font-smoothing:antialiased;text-decoration:none;"><span style="font-family:FontAwesome;font-weight:normal;font-style:normal;line-height:1;"></span></i></a><span style="display:table;clear:both;"></span></div><hr style="box-sizing:content-box;height:0px;margin:15px 0px;border-width:1px 0px 0px;border-right-style:initial;border-bottom-style:initial;border-left-style:initial;border-right-color:initial;border-bottom-color:initial;border-left-color:initial;border-image:initial;border-top-style:solid;border-top-color:rgb(221, 221, 221);"/>

    <div style="position:relative;"><a name="comments" style="background:transparent;color:rgb(5, 147, 211);text-decoration:none;cursor:pointer;position:absolute;top:-65px;"></a></div>
							</div></div></div></div></div></div></div></div></div></div>
</div>
</span>
</div></body></html> 