<html>
<head>
  <title>序列化</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600753 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1923"/>
<h1>序列化</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2019/9/3 3:06</i></td></tr>
</table>
</div>
<br/>

<div><span>
  <div style="--en-clipped-content:article">
<div><br/></div><div style="font-size: 16px; display:block; min-width: 100%; position: relative;"> <div style="font:14px/20px &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;text-size-adjust:100%;background:rgb(255, 255, 255);color:rgb(68, 68, 68);"><div style="font-family:&quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size:14px;line-height:20px;color:rgb(102, 102, 102);background-color:rgb(255, 255, 255);"><div><div style="box-sizing:border-box;"><div style="list-style:none;"><div style="box-sizing:border-box;"><div><div><div><div><p style="margin:0px 0px 15px;">在程序运行的过程中，所有的变量都是在内存中，比如，定义一个dict：</p>
<pre style="margin:0px 0px 15px;margin-top:15px;padding:10px;background:rgb(250, 250, 250);font:12px/18px Consolas, monospace, serif;color:rgb(68, 68, 68);tab-size:4;overflow:auto;border:1px solid rgb(221, 221, 221);border-radius:3px;"><code style="white-space:pre-wrap;"><span>d = <span>dict(name='Bob', age=<span style="color:rgb(0, 153, 153);">20</span>, score=<span style="color:rgb(0, 153, 153);">88</span>)</span></span>
</code></pre>
<p style="margin:0px 0px 15px;margin-top:15px;">可以随时修改变量，比如把<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">name</code>改成<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">'Bill'</code>，但是一旦程序结束，变量所占用的内存就被操作系统全部回收。如果没有把修改后的<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">'Bill'</code>存储到磁盘上，下次重新运行程序，变量又被初始化为<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">'Bob'</code>。</p>
<p style="margin:0px 0px 15px;margin-top:15px;">我们把变量从内存中变成可存储或传输的过程称之为序列化，在Python中叫pickling，在其他语言中也被称之为serialization，marshalling，flattening等等，都是一个意思。</p>
<p style="margin:0px 0px 15px;margin-top:15px;">序列化之后，就可以把序列化后的内容写入磁盘，或者通过网络传输到别的机器上。</p>
<p style="margin:0px 0px 15px;margin-top:15px;">反过来，把变量内容从序列化的对象重新读到内存里称之为反序列化，即unpickling。</p>
<p style="margin:0px 0px 15px;margin-top:15px;">Python提供了<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">pickle</code>模块来实现序列化。</p>
<p style="margin:0px 0px 15px;margin-top:15px;">首先，我们尝试把一个对象序列化并写入文件：</p>
<pre style="margin:0px 0px 15px;margin-top:15px;padding:10px;background:rgb(250, 250, 250);font:12px/18px Consolas, monospace, serif;color:rgb(68, 68, 68);tab-size:4;overflow:auto;border:1px solid rgb(221, 221, 221);border-radius:3px;"><code style="white-space:pre-wrap;"><span style="color:rgb(153, 0, 115);">&gt;&gt;&gt; </span><span style="color:rgb(51, 51, 51);font-weight:bold;">import</span> pickle
<span style="color:rgb(153, 0, 115);">&gt;&gt;&gt; </span>d = dict(name=<span style="color:rgb(221, 17, 68);">'Bob'</span>, age=<span style="color:rgb(0, 153, 153);">20</span>, score=<span style="color:rgb(0, 153, 153);">88</span>)
<span style="color:rgb(153, 0, 115);">&gt;&gt;&gt; </span>pickle.dumps(d)
<span style="color:rgb(221, 17, 68);">b'\x80\x03}q\x00(X\x03\x00\x00\x00ageq\x01K\x14X\x05\x00\x00\x00scoreq\x02KXX\x04\x00\x00\x00nameq\x03X\x03\x00\x00\x00Bobq\x04u.'</span>
</code></pre>
<p style="margin:0px 0px 15px;margin-top:15px;"><code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">pickle.dumps()</code>方法把任意对象序列化成一个<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">bytes</code>，然后，就可以把这个<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">bytes</code>写入文件。或者用另一个方法<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">pickle.dump()</code>直接把对象序列化后写入一个file-like Object：</p>
<pre style="margin:0px 0px 15px;margin-top:15px;padding:10px;background:rgb(250, 250, 250);font:12px/18px Consolas, monospace, serif;color:rgb(68, 68, 68);tab-size:4;overflow:auto;border:1px solid rgb(221, 221, 221);border-radius:3px;"><code style="white-space:pre-wrap;"><span style="color:rgb(153, 0, 115);">&gt;&gt;&gt; </span>f = open(<span style="color:rgb(221, 17, 68);">'dump.txt'</span>, <span style="color:rgb(221, 17, 68);">'wb'</span>)
<span style="color:rgb(153, 0, 115);">&gt;&gt;&gt; </span>pickle.dump(d, f)
<span style="color:rgb(153, 0, 115);">&gt;&gt;&gt; </span>f.close()
</code></pre>
<p style="margin:0px 0px 15px;margin-top:15px;">看看写入的<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">dump.txt</code>文件，一堆乱七八糟的内容，这些都是Python保存的对象内部信息。</p>
<p style="margin:0px 0px 15px;margin-top:15px;">当我们要把对象从磁盘读到内存时，可以先把内容读到一个<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">bytes</code>，然后用<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">pickle.loads()</code>方法反序列化出对象，也可以直接用<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">pickle.load()</code>方法从一个<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">file-like Object</code>中直接反序列化出对象。我们打开另一个Python命令行来反序列化刚才保存的对象：</p>
<pre style="margin:0px 0px 15px;margin-top:15px;padding:10px;background:rgb(250, 250, 250);font:12px/18px Consolas, monospace, serif;color:rgb(68, 68, 68);tab-size:4;overflow:auto;border:1px solid rgb(221, 221, 221);border-radius:3px;"><code style="white-space:pre-wrap;"><span style="color:rgb(153, 0, 115);">&gt;&gt;&gt; </span>f = open(<span style="color:rgb(221, 17, 68);">'dump.txt'</span>, <span style="color:rgb(221, 17, 68);">'rb'</span>)
<span style="color:rgb(153, 0, 115);">&gt;&gt;&gt; </span>d = pickle.load(f)
<span style="color:rgb(153, 0, 115);">&gt;&gt;&gt; </span>f.close()
<span style="color:rgb(153, 0, 115);">&gt;&gt;&gt; </span>d
{<span style="color:rgb(221, 17, 68);">'age'</span>: <span style="color:rgb(0, 153, 153);">20</span>, <span style="color:rgb(221, 17, 68);">'score'</span>: <span style="color:rgb(0, 153, 153);">88</span>, <span style="color:rgb(221, 17, 68);">'name'</span>: <span style="color:rgb(221, 17, 68);">'Bob'</span>}
</code></pre>
<p style="margin:0px 0px 15px;margin-top:15px;">变量的内容又回来了！</p>
<p style="margin:0px 0px 15px;margin-top:15px;">当然，这个变量和原来的变量是完全不相干的对象，它们只是内容相同而已。</p>
<p style="margin:0px 0px 15px;margin-top:15px;">Pickle的问题和所有其他编程语言特有的序列化问题一样，就是它只能用于Python，并且可能不同版本的Python彼此都不兼容，因此，只能用Pickle保存那些不重要的数据，不能成功地反序列化也没关系。</p>
<h3 style="margin:0px 0px 15px;font-family:&quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-weight:normal;color:rgb(68, 68, 68);text-transform:none;margin-top:25px;font-size:18px;line-height:24px;">JSON</h3>
<p style="margin:0px 0px 15px;margin-top:15px;">如果我们要在不同的编程语言之间传递对象，就必须把对象序列化为标准格式，比如XML，但更好的方法是序列化为JSON，因为JSON表示出来就是一个字符串，可以被所有语言读取，也可以方便地存储到磁盘或者通过网络传输。JSON不仅是标准格式，并且比XML更快，而且可以直接在Web页面中读取，非常方便。</p>
<p style="margin:0px 0px 15px;margin-top:15px;">JSON表示的对象就是标准的JavaScript语言的对象，JSON和Python内置的数据类型对应如下：</p>
<table style="font-size:inherit;font-weight:inherit;font-style:inherit;font-variant:inherit;border-collapse:collapse;border-spacing:0px;width:100%;margin-bottom:15px;margin-top:15px;">
<thead>
<tr><th style="padding:8px;border-bottom:1px solid rgb(221, 221, 221);text-align:left;vertical-align:bottom;">JSON类型</th><th style="padding:8px;border-bottom:1px solid rgb(221, 221, 221);text-align:left;vertical-align:bottom;">Python类型</th></tr>
</thead>
<tbody>
<tr><td style="padding:8px;border-bottom:1px solid rgb(221, 221, 221);vertical-align:top;">{}</td><td style="padding:8px;border-bottom:1px solid rgb(221, 221, 221);vertical-align:top;">dict</td></tr>
<tr><td style="padding:8px;border-bottom:1px solid rgb(221, 221, 221);vertical-align:top;">[]</td><td style="padding:8px;border-bottom:1px solid rgb(221, 221, 221);vertical-align:top;">list</td></tr>
<tr><td style="padding:8px;border-bottom:1px solid rgb(221, 221, 221);vertical-align:top;">&quot;string&quot;</td><td style="padding:8px;border-bottom:1px solid rgb(221, 221, 221);vertical-align:top;">str</td></tr>
<tr><td style="padding:8px;border-bottom:1px solid rgb(221, 221, 221);vertical-align:top;">1234.56</td><td style="padding:8px;border-bottom:1px solid rgb(221, 221, 221);vertical-align:top;">int或float</td></tr>
<tr><td style="padding:8px;border-bottom:1px solid rgb(221, 221, 221);vertical-align:top;">true/false</td><td style="padding:8px;border-bottom:1px solid rgb(221, 221, 221);vertical-align:top;">True/False</td></tr>
<tr><td style="padding:8px;border-bottom:1px solid rgb(221, 221, 221);vertical-align:top;">null</td><td style="padding:8px;border-bottom:1px solid rgb(221, 221, 221);vertical-align:top;">None</td></tr>
</tbody>
</table>
<p style="margin:0px 0px 15px;margin-top:15px;">Python内置的<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">json</code>模块提供了非常完善的Python对象到JSON格式的转换。我们先看看如何把Python对象变成一个JSON：</p>
<pre style="margin:0px 0px 15px;margin-top:15px;padding:10px;background:rgb(250, 250, 250);font:12px/18px Consolas, monospace, serif;color:rgb(68, 68, 68);tab-size:4;overflow:auto;border:1px solid rgb(221, 221, 221);border-radius:3px;"><code style="white-space:pre-wrap;"><span style="color:rgb(153, 0, 115);">&gt;&gt;&gt; </span><span style="color:rgb(51, 51, 51);font-weight:bold;">import</span> json
<span style="color:rgb(153, 0, 115);">&gt;&gt;&gt; </span>d = dict(name=<span style="color:rgb(221, 17, 68);">'Bob'</span>, age=<span style="color:rgb(0, 153, 153);">20</span>, score=<span style="color:rgb(0, 153, 153);">88</span>)
<span style="color:rgb(153, 0, 115);">&gt;&gt;&gt; </span>json.dumps(d)
<span style="color:rgb(221, 17, 68);">'{&quot;age&quot;: 20, &quot;score&quot;: 88, &quot;name&quot;: &quot;Bob&quot;}'</span>
</code></pre>
<p style="margin:0px 0px 15px;margin-top:15px;"><code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">dumps()</code>方法返回一个<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">str</code>，内容就是标准的JSON。类似的，<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">dump()</code>方法可以直接把JSON写入一个<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">file-like Object</code>。</p>
<p style="margin:0px 0px 15px;margin-top:15px;">要把JSON反序列化为Python对象，用<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">loads()</code>或者对应的<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">load()</code>方法，前者把JSON的字符串反序列化，后者从<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">file-like Object</code>中读取字符串并反序列化：</p>
<pre style="margin:0px 0px 15px;margin-top:15px;padding:10px;background:rgb(250, 250, 250);font:12px/18px Consolas, monospace, serif;color:rgb(68, 68, 68);tab-size:4;overflow:auto;border:1px solid rgb(221, 221, 221);border-radius:3px;"><code style="white-space:pre-wrap;"><span style="color:rgb(153, 0, 115);">&gt;&gt;&gt; </span>json_str = <span style="color:rgb(221, 17, 68);">'{&quot;age&quot;: 20, &quot;score&quot;: 88, &quot;name&quot;: &quot;Bob&quot;}'</span>
<span style="color:rgb(153, 0, 115);">&gt;&gt;&gt; </span>json.loads(json_str)
{<span style="color:rgb(221, 17, 68);">'age'</span>: <span style="color:rgb(0, 153, 153);">20</span>, <span style="color:rgb(221, 17, 68);">'score'</span>: <span style="color:rgb(0, 153, 153);">88</span>, <span style="color:rgb(221, 17, 68);">'name'</span>: <span style="color:rgb(221, 17, 68);">'Bob'</span>}
</code></pre>
<p style="margin:0px 0px 15px;margin-top:15px;">由于JSON标准规定JSON编码是UTF-8，所以我们总是能正确地在Python的<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">str</code>与JSON的字符串之间转换。</p>
<h3 style="margin:0px 0px 15px;font-family:&quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-weight:normal;color:rgb(68, 68, 68);text-transform:none;margin-top:25px;font-size:18px;line-height:24px;">JSON进阶</h3>
<p style="margin:0px 0px 15px;margin-top:15px;">Python的<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">dict</code>对象可以直接序列化为JSON的<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">{}</code>，不过，很多时候，我们更喜欢用<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">class</code>表示对象，比如定义<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">Student</code>类，然后序列化：</p>
<pre style="margin:0px 0px 15px;margin-top:15px;padding:10px;background:rgb(250, 250, 250);font:12px/18px Consolas, monospace, serif;color:rgb(68, 68, 68);tab-size:4;overflow:auto;border:1px solid rgb(221, 221, 221);border-radius:3px;"><code style="white-space:pre-wrap;"><span style="color:rgb(51, 51, 51);font-weight:bold;">import</span> json

<span style="color:rgb(68, 85, 136);font-weight:bold;"><span style="color:rgb(51, 51, 51);font-weight:bold;">class</span> <span style="color:rgb(68, 85, 136);font-weight:bold;">Student</span><span>(object)</span>:</span>
    <span><span style="color:rgb(51, 51, 51);font-weight:bold;">def</span> <span style="color:rgb(153, 0, 0);font-weight:bold;">__init__</span><span>(self, name, age, score)</span>:</span>
        self.name = name
        self.age = age
        self.score = score

s = Student(<span style="color:rgb(221, 17, 68);">'Bob'</span>, <span style="color:rgb(0, 153, 153);">20</span>, <span style="color:rgb(0, 153, 153);">88</span>)
print(json.dumps(s))
</code></pre>
<p style="margin:0px 0px 15px;margin-top:15px;">运行代码，毫不留情地得到一个<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">TypeError</code>：</p>
<pre style="margin:0px 0px 15px;margin-top:15px;padding:10px;background:rgb(250, 250, 250);font:12px/18px Consolas, monospace, serif;color:rgb(68, 68, 68);tab-size:4;overflow:auto;border:1px solid rgb(221, 221, 221);border-radius:3px;"><code style="white-space:pre-wrap;">Traceback (most recent <span><span style="color:rgb(51, 51, 51);font-weight:bold;">call</span> <span style="color:rgb(51, 51, 51);font-weight:bold;">last</span>):
  ...
TypeError: &lt;__main__.Student object <span style="color:rgb(51, 51, 51);font-weight:bold;">at</span> <span style="color:rgb(0, 153, 153);">0x10603cc50</span>&gt; <span style="color:rgb(51, 51, 51);font-weight:bold;">is</span> <span style="color:rgb(51, 51, 51);font-weight:bold;">not</span> JSON serializable
</span></code></pre>
<p style="margin:0px 0px 15px;margin-top:15px;">错误的原因是<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">Student</code>对象不是一个可序列化为JSON的对象。</p>
<p style="margin:0px 0px 15px;margin-top:15px;">如果连<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">class</code>的实例对象都无法序列化为JSON，这肯定不合理！</p>
<p style="margin:0px 0px 15px;margin-top:15px;">别急，我们仔细看看<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">dumps()</code>方法的参数列表，可以发现，除了第一个必须的<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">obj</code>参数外，<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">dumps()</code>方法还提供了一大堆的可选参数：</p>
<p style="margin:0px 0px 15px;margin-top:15px;"><a href="https://docs.python.org/3/library/json.html#json.dumps" style="background:transparent;color:rgb(5, 147, 211);text-decoration:none;cursor:pointer;" target="_blank">https://docs.python.org/3/library/json.html#json.dumps</a></p>
<p style="margin:0px 0px 15px;margin-top:15px;">这些可选参数就是让我们来定制JSON序列化。前面的代码之所以无法把<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">Student</code>类实例序列化为JSON，是因为默认情况下，<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">dumps()</code>方法不知道如何将<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">Student</code>实例变为一个JSON的<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">{}</code>对象。</p>
<p style="margin:0px 0px 15px;margin-top:15px;">可选参数<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">default</code>就是把任意一个对象变成一个可序列为JSON的对象，我们只需要为<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">Student</code>专门写一个转换函数，再把函数传进去即可：</p>
<pre style="margin:0px 0px 15px;margin-top:15px;padding:10px;background:rgb(250, 250, 250);font:12px/18px Consolas, monospace, serif;color:rgb(68, 68, 68);tab-size:4;overflow:auto;border:1px solid rgb(221, 221, 221);border-radius:3px;"><code style="white-space:pre-wrap;"><span><span style="color:rgb(51, 51, 51);font-weight:bold;">def</span> <span style="color:rgb(153, 0, 0);font-weight:bold;">student2dict</span><span>(std)</span>:</span>
    <span style="color:rgb(51, 51, 51);font-weight:bold;">return</span> {
        <span style="color:rgb(221, 17, 68);">'name'</span>: std.name,
        <span style="color:rgb(221, 17, 68);">'age'</span>: std.age,
        <span style="color:rgb(221, 17, 68);">'score'</span>: std.score
    }
</code></pre>
<p style="margin:0px 0px 15px;margin-top:15px;">这样，<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">Student</code>实例首先被<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">student2dict()</code>函数转换成<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">dict</code>，然后再被顺利序列化为JSON：</p>
<pre style="margin:0px 0px 15px;margin-top:15px;padding:10px;background:rgb(250, 250, 250);font:12px/18px Consolas, monospace, serif;color:rgb(68, 68, 68);tab-size:4;overflow:auto;border:1px solid rgb(221, 221, 221);border-radius:3px;"><code style="white-space:pre-wrap;">&gt;&gt;&gt; <span style="color:rgb(51, 51, 51);font-weight:bold;">print</span>(json.dumps(s, <span style="color:rgb(51, 51, 51);font-weight:bold;">default</span>=student2dict))
{<span style="color:rgb(221, 17, 68);">&quot;age&quot;</span>: <span style="color:rgb(0, 153, 153);">20</span>, <span style="color:rgb(221, 17, 68);">&quot;name&quot;</span>: <span style="color:rgb(221, 17, 68);">&quot;Bob&quot;</span>, <span style="color:rgb(221, 17, 68);">&quot;score&quot;</span>: <span style="color:rgb(0, 153, 153);">88</span>}
</code></pre>
<p style="margin:0px 0px 15px;margin-top:15px;">不过，下次如果遇到一个<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">Teacher</code>类的实例，照样无法序列化为JSON。我们可以偷个懒，把任意<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">class</code>的实例变为<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">dict</code>：</p>
<pre style="margin:0px 0px 15px;margin-top:15px;padding:10px;background:rgb(250, 250, 250);font:12px/18px Consolas, monospace, serif;color:rgb(68, 68, 68);tab-size:4;overflow:auto;border:1px solid rgb(221, 221, 221);border-radius:3px;"><code style="white-space:pre-wrap;"><span style="color:rgb(51, 51, 51);font-weight:bold;">print</span>(json.dumps(s, <span style="color:rgb(51, 51, 51);font-weight:bold;">default</span>=lambda obj: obj.__dict__))
</code></pre>
<p style="margin:0px 0px 15px;margin-top:15px;">因为通常<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">class</code>的实例都有一个<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">__dict__</code>属性，它就是一个<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">dict</code>，用来存储实例变量。也有少数例外，比如定义了<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">__slots__</code>的class。</p>
<p style="margin:0px 0px 15px;margin-top:15px;">同样的道理，如果我们要把JSON反序列化为一个<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">Student</code>对象实例，<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">loads()</code>方法首先转换出一个<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">dict</code>对象，然后，我们传入的<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">object_hook</code>函数负责把<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">dict</code>转换为<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">Student</code>实例：</p>
<pre style="margin:0px 0px 15px;margin-top:15px;padding:10px;background:rgb(250, 250, 250);font:12px/18px Consolas, monospace, serif;color:rgb(68, 68, 68);tab-size:4;overflow:auto;border:1px solid rgb(221, 221, 221);border-radius:3px;"><code style="white-space:pre-wrap;"><span><span style="color:rgb(51, 51, 51);font-weight:bold;">def</span> <span style="color:rgb(153, 0, 0);font-weight:bold;">dict2student</span><span>(d)</span>:</span>
    <span style="color:rgb(51, 51, 51);font-weight:bold;">return</span> Student(d[<span style="color:rgb(221, 17, 68);">'name'</span>], d[<span style="color:rgb(221, 17, 68);">'age'</span>], d[<span style="color:rgb(221, 17, 68);">'score'</span>])
</code></pre>
<p style="margin:0px 0px 15px;margin-top:15px;">运行结果如下：</p>
<pre style="margin:0px 0px 15px;margin-top:15px;padding:10px;background:rgb(250, 250, 250);font:12px/18px Consolas, monospace, serif;color:rgb(68, 68, 68);tab-size:4;overflow:auto;border:1px solid rgb(221, 221, 221);border-radius:3px;"><code style="white-space:pre-wrap;">&gt;&gt;&gt; json_str = '{&quot;age&quot;: 20, &quot;score&quot;: 88, &quot;name&quot;: &quot;Bob&quot;}'
&gt;&gt;&gt; print(json.loads(json_str, object_hook=dict2student))
<span style="color:rgb(0, 0, 128);font-weight:normal;">&lt;<span style="color:rgb(0, 0, 128);font-weight:normal;">__main__.Student</span> <span style="color:rgb(0, 128, 128);">object</span> <span style="color:rgb(0, 128, 128);">at</span> <span style="color:rgb(0, 128, 128);">0x10cd3c190</span>&gt;</span>
</code></pre>
<p style="margin:0px 0px 15px;margin-top:15px;">打印出的是反序列化的<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">Student</code>实例对象。</p>
<h3 style="margin:0px 0px 15px;font-family:&quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-weight:normal;color:rgb(68, 68, 68);text-transform:none;margin-top:25px;font-size:18px;line-height:24px;">练习</h3>
<p style="margin:0px 0px 15px;margin-top:15px;">对中文进行JSON序列化时，<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">json.dumps()</code>提供了一个<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">ensure_ascii</code>参数，观察该参数对结果的影响：</p>
<div style="margin-top:15px;margin-bottom:15px;"><pre style="margin:0px 0px 15px;padding:6px;background:rgb(250, 250, 250);font:12px/18px Consolas, monospace, serif;color:rgb(68, 68, 68);tab-size:4;overflow:auto;border:1px solid rgb(221, 221, 221);border-radius:3px;font-size:14px;margin-bottom:0px;border-bottom:none;border-bottom-left-radius:0px;border-bottom-right-radius:0px;"># -*- coding: utf-8 -*-

import json
</pre><pre style="margin:0px 0px 15px;margin-top:0;padding:6px;background:rgb(250, 250, 250);font:12px/18px Consolas, monospace, serif;color:rgb(68, 68, 68);tab-size:4;overflow:auto;border:1px solid rgb(221, 221, 221);border-radius:3px;font-size:14px;border-top:0;border-top-left-radius:0;border-top-right-radius:0;">print(s)
</pre></div>
<h3 style="margin:0px 0px 15px;font-family:&quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-weight:normal;color:rgb(68, 68, 68);text-transform:none;margin-top:25px;font-size:18px;line-height:24px;">小结</h3>
<p style="margin:0px 0px 15px;margin-top:15px;">Python语言特定的序列化模块是<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">pickle</code>，但如果要把序列化搞得更通用、更符合Web标准，就可以使用<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">json</code>模块。</p>
<p style="margin:0px 0px 15px;margin-top:15px;"><code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">json</code>模块的<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">dumps()</code>和<code style="font-size:12px;font-family:Consolas, monospace, serif;color:rgb(221, 0, 85);padding:0px 4px;border:1px solid rgb(221, 221, 221);border-radius:3px;background:rgb(250, 250, 250);white-space:normal;">loads()</code>函数是定义得非常好的接口的典范。当我们使用时，只需要传入一个必须的参数。但是，当默认的序列化或反序列机制不满足我们的要求时，我们又可以传入更多的参数来定制序列化或反序列化的规则，既做到了接口简单易用，又做到了充分的扩展性和灵活性。</p>
<h3 style="margin:0px 0px 15px;font-family:&quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-weight:normal;color:rgb(68, 68, 68);text-transform:none;margin-top:25px;font-size:18px;line-height:24px;">参考源码</h3>
<p style="margin:0px 0px 15px;margin-top:15px;"><a href="https://github.com/michaelliao/learn-python3/blob/master/samples/io/use_pickle.py" style="background:transparent;color:rgb(5, 147, 211);text-decoration:none;cursor:pointer;" target="_blank">use_pickle.py</a></p>
<p style="margin:0px 0px 15px;margin-top:15px;"><a href="https://github.com/michaelliao/learn-python3/blob/master/samples/io/use_json.py" style="background:transparent;color:rgb(5, 147, 211);text-decoration:none;cursor:pointer;" target="_blank">use_json.py</a></p>
</div></div></div></div></div></div></div></div></div></div></div>
</div>
</span>
</div></body></html> 